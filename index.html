<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SC Ready Practice Test</title>
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 2. Use a clean, modern font (Changed to Poppins) */
        body {
            font-family: 'Poppins', sans-serif;
        }
        /* Added for the Poppins font */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap');

        /* 3. Added Pop-in Animation */
        @keyframes pop-in {
            0% {
                transform: scale(0.95);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .pop-in {
            /* Animation applied by JavaScript */
            animation: pop-in 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        /* 4. Added Loading Spinner */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            width: 2.5rem;
            height: 2.5rem;
            animation: spin 1s linear infinite;
        }
        .loader-gray {
            border-top-color: #4b5563; /* gray-600 */
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- ====================================================== -->
    <!-- == SCREEN 1: LOGIN (New) == -->
    <!-- ====================================================== -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4 md:p-8">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-10 text-center pop-in">
            <h1 class="text-3xl font-bold text-slate-800">
                SC Ready Practice Test ‚úèÔ∏è
            </h1>
            <p class="text-lg text-slate-500 mt-3">
                Please sign in with your account to continue.
            </p>
            
            <!-- New Email/Password Form -->
            <form id="login-form" class="mt-8 space-y-4">
                <div>
                    <input id="login-email" type="email" placeholder="Email" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <input id="login-password" type="password" placeholder="Password" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <button type="submit" id="login-btn" class="w-full flex items-center justify-center gap-3 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-xl shadow-md transition-all duration-300 transform hover:scale-105">
                    Sign In
                </button>
            </form>
            
            <!-- Error messages will appear here -->
            <p id="login-message" class="text-red-500 mt-4 h-6"></p>
        </div>
    </div>


    <!-- ====================================================== -->
    <!-- == SCREEN 2: MAIN CONTENT (Hidden by default) == -->
    <!-- ====================================================== -->
    <div id="main-content" class="min-h-screen flex items-center justify-center p-4 md:p-8 hidden">

        <!-- Main Content Card (Softer corners and shadow) -->
        <div class="w-full max-w-5xl bg-white rounded-2xl shadow-xl p-6 md:p-10 relative overflow-hidden">

            <!-- New Sign Out Button -->
            <button id="logout-btn" class="absolute top-4 right-4 md:top-6 md:right-6 bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-xl transition-all hover:bg-slate-300">
                Sign Out
            </button>

            <!-- ====================================================== -->
            <!-- == TEACHER DASHBOARD SCREEN == -->
            <!-- ====================================================== -->
            <div id="teacher-dashboard-screen" class="hidden">
                <header class="text-center animatable">
                    <h1 class="text-3xl md:text-5xl font-bold text-slate-800">
                        Teacher Dashboard üë©‚Äçüè´
                    </h1>
                    <p class="text-lg md:text-xl text-slate-500 mt-3">
                        Manage your students and view scores.
                    </p>
                </header>

                <div class="mt-10 md:mt-12 grid grid-cols-1 md:grid-cols-2 gap-8">
                    
                    <!-- Create Student Section -->
                    <div class="bg-gray-50 p-6 rounded-2xl shadow-inner">
                        <h2 class="text-2xl font-bold text-slate-700">Create Student Account</h2>
                        <form id="create-student-form" class="mt-4 space-y-4">
                            <div>
                                <label for="student-email" class="block text-sm font-medium text-gray-700">Student Email</label>
                                <input id="student-email" type="email" placeholder="student@email.com" required class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="student-password" class="block text-sm font-medium text-gray-700">Temporary Password</label>
                                <input id="student-password" type="password" placeholder="At least 6 characters" required class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <button type="submit" id="create-student-btn" class="w-full flex items-center justify-center gap-3 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-xl shadow-md transition-all duration-300 transform hover:scale-105">
                                Create Student
                            </button>
                        </form>
                        <p id="create-student-message" class="text-sm mt-3 h-4"></p>
                    </div>

                    <!-- ** NEW ** View Scores Section (Now Dynamic) -->
                    <div class="bg-gray-50 p-6 rounded-2xl shadow-inner">
                        <div class="flex justify-between items-center">
                            <h2 class="text-2xl font-bold text-slate-700">Student Scores</h2>
                            <button id="refresh-scores-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-xl transition-all text-sm">
                                Refresh
                            </button>
                        </div>
                        
                        <div id="scores-list-container" class="mt-4 space-y-3 max-h-60 overflow-y-auto">
                            <!-- Scores will be loaded here by JavaScript -->
                            <p id="scores-message" class="text-slate-500">Click "Refresh" to load scores.</p>
                        </div>
                        
                        <p id="reset-message" class="text-sm mt-3 h-4"></p>
                    </div>
                </div>
            </div>

            <!-- ====================================================== -->
            <!-- == HOME SCREEN (Grade Selection) == -->
            <!-- ====================================================== -->
            <div id="home-screen" class="hidden">
                <header class="text-center animatable">
                    <h1 class="text-3xl md:text-5xl font-bold text-slate-800">
                        SC Ready Practice Test ‚úèÔ∏è
                    </h1>
                    <p class="text-lg md:text-xl text-slate-500 mt-3">
                        Please select a grade level to begin.
                    </I>
                </header>

                <!-- Grade Selection Grid -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8 mt-10 md:mt-12 animatable">
                    
                    <!-- Box 1: 3rd Grade (Button) - New Color, Corners, Emoji -->
                    <button 
                        data-grade="3rd Grade" 
                        data-path="3rd"
                        class="grade-btn text-white p-8 md:p-10 rounded-2xl shadow-md font-bold text-2xl md:text-3xl transition-all duration-300 ease-in-out transform hover:scale-105 hover:shadow-lg bg-blue-500 hover:bg-blue-600">
                        3rd Grade ü•â
                    </button>

                    <!-- Box 2: 4th Grade (Button) - New Color, Corners, Emoji -->
                    <button 
                        data-grade="4th Grade" 
                        data-path="4th"
                        class="grade-btn text-white p-8 md:p-10 rounded-2xl shadow-md font-bold text-2xl md:text-3xl transition-all duration-300 ease-in-out transform hover:scale-105 hover:shadow-lg bg-yellow-500 hover:bg-yellow-600">
                        4th Grade ü•à
                    </button>

                    <!-- Box 3: 5th Grade (Button) - New Color, Corners, Emoji -->
                    <button 
                        data-grade="5th Grade" 
                        data-path="5th"
                        class="grade-btn text-white p-8 md:p-10 rounded-2xl shadow-md font-bold text-2xl md:text-3xl transition-all duration-300 ease-in-out transform hover:scale-105 hover:shadow-lg bg-green-500 hover:bg-green-600">
                        5th Grade ü•á
                    </button>

                    <!-- Box 4: 6th Grade (Button) - New Color, Corners, Emoji -->
                    <button 
                        data-grade="6th Grade" 
                        data-path="6th"
                        class="grade-btn text-white p-8 md:p-10 rounded-2xl shadow-md font-bold text-2xl md:text-3xl transition-all duration-300 ease-in-out transform hover:scale-105 hover:shadow-lg bg-red-500 hover:bg-red-600">
                        6th Grade üéì
                    </button>

                    <!-- Box 5: 4th Grade Science (Direct Link) - New Color, Corners, Emoji -->
                    <button 
                        data-grade="4th Grade Science"
                        data-path="4th Grade Science"
                        class="grade-btn text-white p-8 md:p-10 rounded-2xl shadow-md font-bold text-2xl md:text-3xl transition-all duration-300 ease-in-out transform hover:scale-105 hover:shadow-lg bg-purple-500 hover:bg-purple-600 sm:col-span-1">
                        4Vth Grade Science üß™
                    </button>
                </div>
            </div>

            <!-- ====================================================== -->
            <!-- == SUBJECT SCREEN (ELA / Math Selection) == -->
            <!-- ====================================================== -->
            <div id="subject-screen" class="hidden">
                
                <button id="back-to-grades-btn" class="absolute top-4 left-4 md:top-6 md:left-6 bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-xl transition-all hover:bg-slate-300">
                    &larr; Back
                </button>

                <header class="text-center mt-12 md:mt-0 animatable">
                    <h1 id="subject-title" class="text-3xl md:text-5xl font-bold text-slate-800"></h1>
                    <p class="text-lg md:text-xl text-slate-500 mt-3">
                        Please select a subject.
                    </p>
                </header>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-10 mt-10 md:mt-12 animatable">
                    
                    <button 
                        id="ela-btn"
                        data-subject="ELA"
                        class="subject-btn flex items-center justify-center text-center text-white p-16 md:p-24 rounded-2xl shadow-md font-bold text-4xl transition-all duration-300 ease-in-out transform hover:scale-105 hover:shadow-lg bg-sky-500 hover:bg-sky-600">
                        ELA üìö
                    </button>
                    
                    <button 
                        id="math-btn"
                        data-subject="Mathematics"
                        class="subject-btn flex items-center justify-center text-center text-white p-16 md:p-24 rounded-2xl shadow-md font-bold text-4xl transition-all duration-300 ease-in-out transform hover:scale-105 hover:shadow-lg bg-orange-500 hover:bg-orange-600">
                        Mathematics üßÆ
                    </button>
                </div>
            </div>

            <!-- ====================================================== -->
            <!-- == TEST SELECTION SCREEN == -->
            <!-- ====================================================== -->
            <div id="test-selection-screen" class="hidden">
                
                <button id="back-to-subjects-btn" class="absolute top-4 left-4 md:top-6 md:left-6 bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-xl transition-all hover:bg-slate-300">
                    &larr; Back
                </button>

                <header class="text-center mt-12 md:mt-0 animatable">
                    <h1 id="test-title" class="text-3xl md:text-5xl font-bold text-slate-800"></h1>
                    <p id="test-subtitle" class="text-lg md:text-xl text-slate-500 mt-3">
                        Please select a test.
                    </p>
                </header>

                <div id="loading-spinner" class="mt-12 flex justify-center items-center h-40">
                    <div class="loader loader-gray"></div>
                    <p class="ml-4 text-slate-600 text-lg">Loading Tests...</p>
                </div>

                <div id="test-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8 mt-10 md:mt-12 animatable">
                    <!-- Test buttons will be generated by JavaScript and inserted here -->
                </div>
                <p id="error-message" class="text-center text-red-500 mt-8 text-lg"></p>
            </div>

            <!-- ====================================================== -->
            <!-- == NEW SCREEN 4: TEST TAKER == -->
            <!-- ====================================================== -->
            <div id="test-taker-screen" class="hidden">
                <button id="back-to-tests-btn" class="absolute top-4 left-4 md:top-6 md:left-6 bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-xl transition-all hover:bg-slate-300">
                    &larr; Back to Tests
                </button>

                <header class="text-center mt-12 md:mt-0 animatable">
                    <h1 id="quiz-title" class="text-3xl md:text-5xl font-bold text-slate-800"></h1>
                    <p id="quiz-standard" class="text-lg md:text-xl text-slate-500 mt-3"></p>
                </header>

                <!-- ** MODIFIED ** Form is now just a container for questions -->
                <form id="quiz-form" class="mt-10 md:mt-12 space-y-8 animatable min-h-[200px]">
                    <!-- Quiz questions will be generated by JavaScript and inserted here -->
                </form>

                <!-- ** NEW ** Navigation Buttons -->
                <div id="quiz-navigation" class="mt-8 flex justify-between items-center">
                    <button id="prev-question-btn" class="bg-slate-500 hover:bg-slate-600 text-white font-bold py-3 px-6 rounded-xl shadow-md transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                        &larr; Previous
                    </button>
                    
                    <p id="question-counter" class="text-slate-600 font-semibold"></p>
                    
                    <button id="next-question-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-xl shadow-md transition-all duration-300">
                        Next &rarr;
                    </button>
                    
                    <!-- This button is now hidden by default and shown on the last question -->
                    <button id="submit-test-btn" class="w-auto hidden flex items-center justify-center gap-3 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-xl shadow-md transition-all duration-300 transform hover:scale-105">
                        Submit Test for Grading
                    </button>
                </div>
                <p id="test-submit-message" class="text-center text-red-500 mt-4 h-6"></p>
            </div>

            <!-- ====================================================== -->
            <!-- == NEW SCREEN 5: SCORE SCREEN == -->
            <!-- ====================================================== -->
            <div id="score-screen" class="hidden">
                <header class="text-center animatable">
                    <h1 class="text-2xl md:text-4xl font-bold text-slate-800">
                        Test Submitted!
                    </h1>
                    <p class="text-6xl md:text-8xl font-bold text-blue-600 mt-6" id="final-score">
                        <!-- e.g., 8/10 -->
                    </p>
                    <p class="text-2xl md:text-3xl text-slate-600 mt-4" id="score-message">
                        <!-- e.g., Great job! -->
                    </p>
                </header>

                <!-- NEW AI Report Section -->
                <div id="ai-report-section" class="mt-12 animatable hidden">
                    <div class="bg-gray-50 p-6 rounded-2xl shadow-inner">
                        <h2 class="text-2xl font-bold text-slate-700">Your Personal Practice Plan ü§ñ</h2>
                        <p class="text-slate-600 mt-2">You missed a few questions on these skills. Here are some resources to help you master them!</p>
                        
                        <div id="ai-report-content" class="mt-6 space-y-4">
                            <!-- AI-generated content will go here -->
                        </div>
                        
                        <button id="get-ai-report-btn" class="w-full mt-6 flex items-center justify-center gap-3 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-xl shadow-md transition-all duration-300 transform hover:scale-105">
                            Generate My Practice Plan
                        </button>
                        <p id="ai-report-message" class="text-center text-slate-600 mt-4 h-6"></p>
                    </div>
                </div>

                <button id="back-to-home-btn" class="w-full mt-8 flex items-center justify-center gap-3 bg-slate-600 hover:bg-slate-700 text-white font-bold py-4 px-6 rounded-xl shadow-md transition-all duration-300 transform hover:scale-105">
                    Back to Home
                </button>
            </div>


        </div>
    </div>


    <!-- 3. JavaScript for Navigation AND AUTHENTICATION -->
    
    <!-- Import Firebase SDKs -->
    <script type="module">
        // Import functions from the Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        
        // *** MODIFIED *** Import more Firestore functions
        import { 
            getFirestore, 
            doc, 
            getDoc,
            setDoc,
            addDoc,
            collection,
            serverTimestamp,
            query,
            getDocs,
            deleteDoc
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // --- 1. FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBfvwMOWXRqN1QmFVoHJZo2mWvnrQMxm1k",
            authDomain: "scready-f7bc9.firebaseapp.com",
            projectId: "scready-f7bc9",
            storageBucket: "scready-f7bc9.appspot.com",
            messagingSenderId: "94383995704",
            appId: "1:94383995704:web:3a16a7cd3e74fabf34dfcd",
            measurementId: "G-CH5SBDKBEL"
        };

        // --- 2. GITHUB REPO CONFIGURATION ---
        const GITHUB_REPO_URL = "https://github.com/stevenraymond8592-create/scready";
        const GITHUB_BRANCH = "main";
        
        let GITHUB_OWNER = 'YOUR_USERNAME';
        let GITHUB_REPO = 'YOUR_REPO_NAME';
        try {
            const urlParts = new URL(GITHUB_REPO_URL);
            const pathParts = urlParts.pathname.split('/').filter(Boolean); 
            if (pathParts.length >= 2) {
                GITHUB_OWNER = pathParts[0];
                GITHUB_REPO = pathParts[1];
            }
        } catch (e) {
            console.error("Could not parse GITHUB_REPO_URL. Please ensure it's a valid URL.");
        }
        
        const GITHUB_API_URL = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents`;
        // --- END CONFIGURATION ---

        
        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);

        
        // --- Get UI Elements ---
        const loginScreen = document.getElementById('login-screen');
        const mainContent = document.getElementById('main-content');
        
        const loginForm = document.getElementById('login-form');
        const loginEmail = document.getElementById('login-email');
        const loginPassword = document.getElementById('login-password');
        
        const logoutBtn = document.getElementById('logout-btn');
        const loginMessage = document.getElementById('login-message');
        
        // Dashboard Elements
        const teacherDashboardScreen = document.getElementById('teacher-dashboard-screen');
        const createStudentForm = document.getElementById('create-student-form');
        const studentEmail = document.getElementById('student-email');
        const studentPassword = document.getElementById('student-password');
        const createStudentBtn = document.getElementById('create-student-btn');
        const createStudentMessage = document.getElementById('create-student-message');
        const refreshScoresBtn = document.getElementById('refresh-scores-btn');
        const scoresListContainer = document.getElementById('scores-list-container');
        const scoresMessage = document.getElementById('scores-message');
        const resetMessage = document.getElementById('reset-message');


        // Student Screens
        const homeScreen = document.getElementById('home-screen');
        const subjectScreen = document.getElementById('subject-screen');
        const testSelectionScreen = document.getElementById('test-selection-screen');

        const gradeButtons = document.querySelectorAll('.grade-btn');
        const backToGradesBtn = document.getElementById('back-to-grades-btn');
        const subjectTitle = document.getElementById('subject-title');
        
        const subjectButtons = document.querySelectorAll('.subject-btn');

        // Test Screen Elements
        const backToSubjectsBtn = document.getElementById('back-to-subjects-btn');
        const testTitle = document.getElementById('test-title');
        const testSubtitle = document.getElementById('test-subtitle');
        const loadingSpinner = document.getElementById('loading-spinner');
        const testGrid = document.getElementById('test-grid');
        const errorMessage = document.getElementById('error-message');
        
        // Test Taker Elements
        const testTakerScreen = document.getElementById('test-taker-screen');
        const backToTestsBtn = document.getElementById('back-to-tests-btn');
        const quizTitle = document.getElementById('quiz-title');
        const quizStandard = document.getElementById('quiz-standard');
        const quizForm = document.getElementById('quiz-form');
        const submitTestBtn = document.getElementById('submit-test-btn');
        const testSubmitMessage = document.getElementById('test-submit-message');
        // ** NEW ** Test Navigation Elements
        const quizNavigation = document.getElementById('quiz-navigation');
        const prevQuestionBtn = document.getElementById('prev-question-btn');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const questionCounter = document.getElementById('question-counter');


        // Score Screen Elements
        const scoreScreen = document.getElementById('score-screen');
        const finalScore = document.getElementById('final-score');
        const scoreMessage = document.getElementById('score-message');
        const aiReportSection = document.getElementById('ai-report-section');
        const getAiReportBtn = document.getElementById('get-ai-report-btn');
        const aiReportContent = document.getElementById('ai-report-content');
        const aiReportMessage = document.getElementById('ai-report-message');
        const backToHomeBtn = document.getElementById('back-to-home-btn');
        
        // Animation collections
        const allScreens = [
            loginScreen, 
            teacherDashboardScreen, 
            homeScreen, 
            subjectScreen, 
            testSelectionScreen,
            testTakerScreen,
            scoreScreen
        ];
        
        // --- Global State Variables ---
        let currentGrade = '';
        let currentGradePath = '';
        let currentSubject = '';
        let currentQuizData = null; 
        let currentUserId = null; 
        let currentQuestionIndex = 0; // ** NEW ** For test navigation

        
        // --- 4. AUTHENTICATION LOGIC ---

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault(); 
            const email = loginEmail.value;
            const password = loginPassword.value;
            loginMessage.textContent = "Signing in...";

            signInWithEmailAndPassword(auth, email, password)
                .catch((error) => {
                    console.error("Sign-in error", error.code);
                    if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                        loginMessage.textContent = "Invalid email or password.";
                    } else {
                        loginMessage.textContent = "Sign-in failed. Please try again.";
                    }
                });
        });

        logoutBtn.addEventListener('click', () => {
            signOut(auth);
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid; 
                checkUserRole(user);
            } else {
                currentUserId = null;
                showLoginScreen();
            }
        });

        async function checkUserRole(user) {
            loginMessage.textContent = "Checking authorization...";
            try {
                const docRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    const role = userData.role;

                    if (role === 'teacher') {
                        showTeacherDashboard();
                    } else if (role === 'student') {
                        showStudentContent();
                    } else {
                        loginMessage.textContent = "Your account has an invalid role.";
                        signOut(auth);
                    }
                } else {
                    loginMessage.textContent = "Your account is not configured. Please contact an administrator.";
                    signOut(auth);
                }
            } catch (error) {
                console.error("Error checking user role:", error);
                if (error.code === 'permission-denied' || (error.message && error.message.includes("permissions"))) {
                    loginMessage.textContent = "Error: Please check your Firestore Security Rules.";
                    console.log("FIX: Go to your Firestore 'Rules' tab and ensure you allow users to read their own document in the 'users' collection.");
                } else {
                    loginMessage.textContent = "An error occurred while checking your role.";
                }
                signOut(auth);
            }
        }

        // --- 5. SCREEN NAVIGATION LOGIC ---

        function showLoginScreen() {
            mainContent.classList.add('hidden');
            loginScreen.classList.remove('hidden');
            loginMessage.textContent = ""; 
        }

        function showTeacherDashboard() {
            loginScreen.classList.add('hidden');
            mainContent.classList.remove('hidden');
            loginMessage.textContent = "";
            animateScreenTransition(null, teacherDashboardScreen);
            
            fetchStudentScores();
        }

        function showStudentContent() {
            loginScreen.classList.add('hidden');
            mainContent.classList.remove('hidden');
            loginMessage.textContent = "";
            animateScreenTransition(null, homeScreen);
        }

        function animateScreenTransition(screenToHide, screenToShow) {
            allScreens.forEach(screen => {
                if(screen.id !== screenToShow.id) {
                     screen.classList.add('hidden');
                }
            });

            if (screenToShow.id !== 'login-screen') {
                mainContent.classList.remove('hidden');
            }

            const animatables = screenToShow.querySelectorAll('.animatable');
            
            animatables.forEach(el => {
                el.classList.remove('pop-in'); 
                void el.offsetWidth; // Force browser reflow
                el.classList.add('pop-in'); 
            });

            screenToShow.classList.remove('hidden');
            window.scrollTo(0, 0);
        }
        
        // --- 6. STUDENT NAVIGATION LOGIC ---
        
        gradeButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                currentGrade = e.currentTarget.dataset.grade; 
                currentGradePath = e.currentTarget.dataset.path;
                
                if (currentGradePath === "4th Grade Science") {
                    currentSubject = ""; 
                    testTitle.textContent = currentGrade;
                    testSubtitle.textContent = "Please select a test.";
                    fetchTestsFromGitHub(currentGradePath); 
                    animateScreenTransition(homeScreen, testSelectionScreen);
                } else {
                    subjectTitle.textContent = currentGrade;
                    animateScreenTransition(homeScreen, subjectScreen);
                }
            });
        });

        subjectButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                currentSubject = e.currentTarget.dataset.subject;
                
                testTitle.textContent = `${currentGrade} - ${currentSubject}`;
                testSubtitle.textContent = "Please select a test.";
                
                const dataPath = `${currentGradePath}/${currentSubject}`;
                fetchTestsFromGitHub(dataPath);
                animateScreenTransition(subjectScreen, testSelectionScreen);
            });
        });

        // Back buttons
        backToGradesBtn.addEventListener('click', () => animateScreenTransition(subjectScreen, homeScreen));
        backToSubjectsBtn.addEventListener('click', () => {
             if (currentGradePath === "4th Grade Science") {
                animateScreenTransition(testSelectionScreen, homeScreen); 
             } else {
                animateScreenTransition(testSelectionScreen, subjectScreen);
             }
        });
        backToTestsBtn.addEventListener('click', () => {
            // ** MODIFIED ** Reset button visibility when going back
            submitTestBtn.classList.add('hidden');
            nextQuestionBtn.classList.remove('hidden');
            animateScreenTransition(testTakerScreen, testSelectionScreen);
        });
        backToHomeBtn.addEventListener('click', () => animateScreenTransition(scoreScreen, homeScreen));
        

        async function fetchTestsFromGitHub(dataPath) {
            errorMessage.textContent = ""; 
            testGrid.innerHTML = ''; 
            loadingSpinner.classList.remove('hidden'); 

            const apiUrl = `${GITHUB_API_URL}/${dataPath}?ref=${GITHUB_BRANCH}`;

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`Folder not found (404). Check your repo structure.`);
                }
                const items = await response.json();
                
                const tests = items.filter(item => item.type === 'file' && item.name.endsWith('.json'));

                if (tests.length === 0) {
                    testSubtitle.textContent = "No tests found in this folder.";
                } else {
                    testSubtitle.textContent = "Please select a test.";
                    tests.forEach(item => {
                        const testButton = document.createElement('button');
                        testButton.dataset.downloadUrl = item.download_url;
                        
                        const displayName = item.name.replace(/_/g, ' ').replace(/\.json$/i, '');
                        
                        testButton.textContent = displayName;
                        testButton.className = "test-btn flex items-center justify-center text-center text-white p-8 rounded-2xl shadow-md font-bold text-xl transition-all duration-300 ease-in-out transform hover:scale-105 hover:shadow-lg bg-slate-600 hover:bg-slate-700";
                        
                        testButton.addEventListener('click', () => startTest(item.download_url));
                        
                        testGrid.appendChild(testButton);
                    });
                }

            } catch (error) {
                console.error("Error fetching GitHub tests:", error);
                errorMessage.textContent = `Error loading tests. (${error.message})`;
            } finally {
                loadingSpinner.classList.add('hidden'); 
            }
        }
        
        // --- 7. TEST TAKER LOGIC ---
        
        async function startTest(downloadUrl) {
            quizForm.innerHTML = '<div class="loader loader-gray mx-auto"></div>';
            quizTitle.textContent = "Loading Test...";
            quizStandard.textContent = "";
            testSubmitMessage.textContent = "";
            
            // ** NEW ** Reset button visibility
            submitTestBtn.classList.add('hidden');
            nextQuestionBtn.classList.remove('hidden');
            
            animateScreenTransition(testSelectionScreen, testTakerScreen);

            try {
                const response = await fetch(downloadUrl);
                if (!response.ok) throw new Error("Could not download test file.");
                
                const quizData = await response.json();
                currentQuizData = quizData; 
                renderTest(quizData);
                
            } catch (error) {
                console.error("Error starting test:", error);
                quizForm.innerHTML = `<p class="text-red-500 text-center">Error: Could not load this test. Please go back and try again.</p>`;
                quizNavigation.classList.add('hidden'); // Hide nav buttons on error
            }
        }

        /**
         * ** MODIFIED **
         * Renders all questions but only shows the first one.
         */
        function renderTest(quizData) {
            quizForm.innerHTML = ''; 
            quizNavigation.classList.remove('hidden'); // Show nav buttons
            quizTitle.textContent = quizData.title;
            quizStandard.textContent = `Standard: ${quizData.standard}`;
            currentQuestionIndex = 0; // Reset index

            quizData.questions.forEach((question, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.id = `question-${index}`;
                // ** MODIFIED ** Add 'question-slide' class and 'hidden'
                questionDiv.className = "question-slide bg-gray-50 p-6 rounded-2xl shadow-inner hidden";
                
                let optionsHtml = '';
                // TODO: Add support for other question types (EBSR, etc.)
                if (question.type === "Multiple-Choice") {
                    const optionsArray = question.options.map((option, i) => `
                        <label class="flex items-center p-4 border rounded-xl has-[:checked]:bg-blue-100 has-[:checked]:border-blue-500 cursor-pointer">
                            <input type="radio" name="question-${index}" value="${i}" class="h-5 w-5 text-blue-600" required>
                            <span class="ml-4 text-lg text-slate-700">${option}</span>
                        </label>
                    `).join('');
                    
                    optionsHtml = `<div class="space-y-3 mt-4">${optionsArray}</div>`;
                }
                
                questionDiv.innerHTML = `
                    <p class="text-lg font-semibold text-slate-700">Question ${index + 1} of ${quizData.questions.length}</p>
                    ${question.stimulus ? `<div class="text-lg text-slate-800 mt-4 p-4 border-l-4 border-gray-300">${question.stimulus}</div>` : ''}
                    <p class="text-xl text-slate-900 mt-4">${question.stem}</p>
                    ${optionsHtml}
                `;
                quizForm.appendChild(questionDiv);
            });
            
            // ** NEW ** Show the first question
            showQuestion(0);
        }
        
        /**
         * ** NEW **
         * Shows a specific question by index and updates nav buttons.
         */
        function showQuestion(index) {
            // Hide all questions
            document.querySelectorAll('.question-slide').forEach(slide => {
                slide.classList.add('hidden');
            });
            
            // Show the target question
            const targetQuestion = document.getElementById(`question-${index}`);
            if (targetQuestion) {
                targetQuestion.classList.remove('hidden');
            }

            currentQuestionIndex = index;

            // Update counter
            questionCounter.textContent = `Question ${index + 1} of ${currentQuizData.questions.length}`;

            // Update button visibility
            prevQuestionBtn.disabled = (index === 0);

            if (index === currentQuizData.questions.length - 1) {
                // Last question
                nextQuestionBtn.classList.add('hidden');
                submitTestBtn.classList.remove('hidden');
            } else {
                // Not the last question
                nextQuestionBtn.classList.remove('hidden');
                submitTestBtn.classList.add('hidden');
            }
        }
        
        // ** NEW ** Add listeners for Next/Prev buttons
        nextQuestionBtn.addEventListener('click', () => {
            showQuestion(currentQuestionIndex + 1);
        });
        
        prevQuestionBtn.addEventListener('click', () => {
            showQuestion(currentQuestionIndex - 1);
        });
        
        // ---
        
        quizForm.addEventListener('submit', (e) => {
            e.preventDefault();
            handleSubmitTest();
        });
        
        submitTestBtn.addEventListener('click', () => {
            // Check validity before submitting.
            // This is simple and checks all questions at once.
            if (quizForm.checkValidity()) {
                quizForm.requestSubmit();
            } else {
                testSubmitMessage.textContent = "Please answer all questions before submitting.";
                // Find first invalid question and show it
                let firstInvalid = -1;
                for(let i = 0; i < currentQuizData.questions.length; i++) {
                    const inputs = document.getElementsByName(`question-${i}`);
                    let oneChecked = false;
                    inputs.forEach(input => {
                        if(input.checked) oneChecked = true;
                    });
                    if(!oneChecked) {
                        firstInvalid = i;
                        break;
                    }
                }
                if(firstInvalid !== -1) {
                    showQuestion(firstInvalid);
                    testSubmitMessage.textContent = `Please answer Question ${firstInvalid + 1}.`;
                }
            }
        });

        async function handleSubmitTest() {
            if (!currentQuizData || !currentUserId) return;
            
            testSubmitMessage.textContent = "Submitting...";

            let score = 0;
            const failedSkills = new Set();
            const formData = new FormData(quizForm);

            currentQuizData.questions.forEach((question, index) => {
                const selectedAnswer = formData.get(`question-${index}`); 
                
                if (selectedAnswer == question.correctAnswerIndex) {
                    score++;
                } else {
                    if(question.skill) {
                        failedSkills.add(question.skill);
                    }
                }
            });

            const total = currentQuizData.questions.length;
            const percentage = Math.round((score / total) * 100);

            finalScore.textContent = `${score} / ${total}`;
            if (percentage >= currentQuizData.passingScore) {
                scoreMessage.textContent = `Congratulations, you passed! (${percentage}%)`;
                aiReportSection.classList.add('hidden'); 
            } else {
                scoreMessage.textContent = `Don't give up, you'll get it next time! (${percentage}%)`;
                aiReportSection.classList.remove('hidden'); 
            }
            animateScreenTransition(testTakerScreen, scoreScreen);
            
            testSubmitMessage.textContent = ""; // Clear message

            try {
                const submissionsRef = collection(db, "submissions");
                await addDoc(submissionsRef, {
                    studentId: currentUserId,
                    studentEmail: auth.currentUser.email, 
                    testTitle: currentQuizData.title,
                    testStandard: currentQuizData.standard,
                    score: score,
                    totalQuestions: total,
                    percentage: percentage,
                    failedSkills: Array.from(failedSkills),
                    submittedAt: serverTimestamp()
                });
            } catch (error) {
                console.error("Error saving submission:", error);
            }
        }
        
        getAiReportBtn.addEventListener('click', () => {
            aiReportMessage.textContent = "Generating your report... (AI feature coming soon!)";
        });


        // --- 8. TEACHER DASHBOARD LOGIC ---
        
        createStudentForm.addEventListener('submit', (e) => {
            e.preventDefault();
            createStudentMessage.textContent = "Connecting to backend...";
            
            setTimeout(() => {
                // This is a placeholder. We will build the function next.
                createStudentMessage.innerHTML = "Error: Backend function not deployed. <br> This requires a paid Firebase plan.";
            }, 1000);
        });

        refreshScoresBtn.addEventListener('click', fetchStudentScores);

        async function fetchStudentScores() {
            scoresMessage.textContent = "Loading scores...";
            scoresListContainer.innerHTML = ''; 
            resetMessage.textContent = "";

            try {
                const q = query(collection(db, "submissions"));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    scoresMessage.textContent = "No student submissions found.";
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const submission = doc.data();
                    const submissionId = doc.id; 

                    const scoreElement = document.createElement('div');
                    scoreElement.className = "flex justify-between items-center bg-white p-3 rounded-lg shadow-sm";
                    
                    scoreElement.innerHTML = `
                        <div>
                            <p class="font-semibold text-slate-700">${submission.testTitle}</p>
                            <p class="text-sm text-slate-500">${submission.studentEmail || 'Unknown Student'}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-blue-600">${submission.score} / ${submission.totalQuestions} (${submission.percentage}%)</p>
                            <button data-id="${submissionId}" class="reset-btn text-xs text-red-500 hover:underline">
                                Reset
                            </button>
                        </div>
                    `;
                    scoresListContainer.appendChild(scoreElement);
                });

                document.querySelectorAll('.reset-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const subId = e.currentTarget.dataset.id;
                        if (confirm("Are you sure you want to reset this student's score? This cannot be undone.")) {
                            resetScore(subId);
                        }
                    });
                });

            } catch (error)
            {
                console.error("Error fetching scores:", error);
                if (error.code === 'permission-denied') {
                    scoresMessage.innerHTML = `<span class="font-bold text-red-600">Error: Permission Denied.</span><br>You must update your Firestore Rules to allow teachers to read the 'submissions' collection.`;
                    console.log("--- FIX FOR PERMISSION DENIED ---");
                    console.log("Go to your Firebase Project -> Firestore Database -> Rules tab.");
                    console.log("Copy and paste these rules and click 'Publish':");
                    console.log(`
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if false; 
    }

    match /submissions/{submissionId} {
      allow create: if request.auth != null && request.resource.data.studentId == request.auth.uid;
      allow read, delete: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'teacher';
    }
  }
}
                    `);
                    console.log("--- END OF FIX ---");
                } else {
                    scoresMessage.textContent = "An error occurred fetching scores.";
                }
            }
        }

        async function resetScore(submissionId) {
            resetMessage.textContent = "Resetting score...";
            
            try {
                const submissionRef = doc(db, "submissions", submissionId);
                
                await deleteDoc(submissionRef);
                
                resetMessage.textContent = "Score reset successfully.";
                
                await fetchStudentScores();

            } catch (error) {
                console.error("Error resetting score:", error);
                if (error.code === 'permission-denied') {
                    resetMessage.textContent = "Error: You do not have permission to reset scores.";
                    console.log("FIX: Ensure your 'submissions' rule allows 'delete' for teachers. (See rule from 'Error fetching scores'.)");
                } else {
                    resetMessage.textContent = "An error occurred while resetting.";
                }
            }
        }

    </script>

</body>
</html>


