<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SC Ready Practice Test</title>
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 2. Use a clean, modern font (Changed to Poppins) */
        body {
            font-family: 'Poppins', sans-serif;
        }
        /* Added for the Poppins font */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap');

        /* 3. Added Pop-in Animation */
        @keyframes pop-in {
            0% {
                transform: scale(0.95);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .pop-in {
            /* Animation applied by JavaScript */
            animation: pop-in 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        /* 4. Added Loading Spinner */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            width: 2.5rem;
            height: 2.5rem;
            animation: spin 1s linear infinite;
        }
        .loader-gray {
            border-top-color: #4b5563; /* gray-600 */
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- ====================================================== -->
    <!-- == SCREEN 1: LOGIN (New) == -->
    <!-- ====================================================== -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4 md:p-8">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-10 text-center pop-in">
            <h1 class="text-3xl font-bold text-slate-800">
                SC Ready Practice Test ‚úèÔ∏è
            </h1>
            <p class="text-lg text-slate-500 mt-3">
                Please sign in with your account to continue.
            </p>
            
            <!-- New Email/Password Form -->
            <form id="login-form" class="mt-8 space-y-4">
                <div>
                    <input id="login-email" type="email" placeholder="Email" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <input id="login-password" type="password" placeholder="Password" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <button type="submit" id="login-btn" class="w-full flex items-center justify-center gap-3 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-xl shadow-md transition-all duration-300 transform hover:scale-105">
                    Sign In
                </button>
            </form>
            
            <!-- Error messages will appear here -->
            <p id="login-message" class="text-red-500 mt-4 h-6"></p>
        </div>
    </div>


    <!-- ====================================================== -->
    <!-- == SCREEN 2: MAIN CONTENT (Hidden by default) == -->
    <!-- ====================================================== -->
    <div id="main-content" class="min-h-screen flex items-center justify-center p-4 md:p-8 hidden">

        <!-- Main Content Card (Softer corners and shadow) -->
        <div class="w-full max-w-5xl bg-white rounded-2xl shadow-xl p-6 md:p-10 relative overflow-hidden">

            <!-- New Sign Out Button -->
            <button id="logout-btn" class="absolute top-4 right-4 md:top-6 md:right-6 bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-xl transition-all hover:bg-slate-300">
                Sign Out
            </button>

            <!-- ====================================================== -->
            <!-- == TEACHER DASHBOARD SCREEN == -->
            <!-- ====================================================== -->
            <div id="teacher-dashboard-screen" class="hidden">
                <header class="text-center animatable">
                    <h1 class="text-3xl md:text-5xl font-bold text-slate-800">
                        Teacher Dashboard üë©‚Äçüè´
                    </h1>
                    <p class="text-lg md:text-xl text-slate-500 mt-3">
                        Manage your students and view scores.
                    </p>
                </header>

                <div class="mt-10 md:mt-12 grid grid-cols-1 md:grid-cols-2 gap-8">
                    
                    <!-- Create Student Section -->
                    <div class="bg-gray-50 p-6 rounded-2xl shadow-inner">
                        <h2 class="text-2xl font-bold text-slate-700">Create Student Account</h2>
                        <form id="create-student-form" class="mt-4 space-y-4">
                            <div>
                                <label for="student-email" class="block text-sm font-medium text-gray-700">Student Email</label>
                                <input id="student-email" type="email" placeholder="student@email.com" required class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="student-password" class="block text-sm font-medium text-gray-700">Temporary Password</label>
                                <input id="student-password" type="password" placeholder="At least 6 characters" required class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <button type="submit" id="create-student-btn" class="w-full flex items-center justify-center gap-3 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-xl shadow-md transition-all duration-300 transform hover:scale-105">
                                Create Student
                            </button>
                        </form>
                        <p id="create-student-message" class="text-sm mt-3 h-4"></p>
                    </div>

                    <!-- View Scores Section (Placeholder) -->
                    <div class="bg-gray-50 p-6 rounded-2xl shadow-inner">
                        <h2 class="text-2xl font-bold text-slate-700">Student Scores</h2>
                        <p class="text-slate-500 mt-4">
                            This feature is coming soon. Once students submit tests, their scores will appear here.
                        </p>
                    </div>
                </div>
            </div>

            <!-- ====================================================== -->
            <!-- == HOME SCREEN (Grade Selection) == -->
            <!-- ====================================================== -->
            <div id="home-screen" class="hidden">
                <header class="text-center animatable">
                    <h1 class="text-3xl md:text-5xl font-bold text-slate-800">
                        SC Ready Practice Test ‚úèÔ∏è
                    </h1>
                    <p class="text-lg md:text-xl text-slate-500 mt-3">
                        Please select a grade level to begin.
                    </I>
                </header>

                <!-- Grade Selection Grid -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8 mt-10 md:mt-12 animatable">
                    
                    <!-- Box 1: 3rd Grade (Button) - New Color, Corners, Emoji -->
                    <button 
                        data-grade="3rd Grade" 
                        data-path="3rd"
                        class="grade-btn text-white p-8 md:p-10 rounded-2xl shadow-md font-bold text-2xl md:text-3xl transition-all duration-300 ease-in-out transform hover:scale-105 hover:shadow-lg bg-blue-500 hover:bg-blue-600">
                        3rd Grade ü•â
                    </button>

                    <!-- Box 2: 4th Grade (Button) - New Color, Corners, Emoji -->
                    <button 
                        data-grade="4th Grade" 
                        data-path="4th"
                        class="grade-btn text-white p-8 md:p-10 rounded-2xl shadow-md font-bold text-2xl md:text-3xl transition-all duration-300 ease-in-out transform hover:scale-105 hover:shadow-lg bg-yellow-500 hover:bg-yellow-600">
                        4th Grade ü•à
                    </button>

                    <!-- Box 3: 5th Grade (Button) - New Color, Corners, Emoji -->
                    <button 
                        data-grade="5th Grade" 
                        data-path="5th"
                        class="grade-btn text-white p-8 md:p-10 rounded-2xl shadow-md font-bold text-2xl md:text-3xl transition-all duration-300 ease-in-out transform hover:scale-105 hover:shadow-lg bg-green-500 hover:bg-green-600">
                        5th Grade ü•á
                    </button>

                    <!-- Box 4: 6th Grade (Button) - New Color, Corners, Emoji -->
                    <button 
                        data-grade="6th Grade" 
                        data-path="6th"
                        class="grade-btn text-white p-8 md:p-10 rounded-2xl shadow-md font-bold text-2xl md:text-3xl transition-all duration-300 ease-in-out transform hover:scale-105 hover:shadow-lg bg-red-500 hover:bg-red-600">
                        6th Grade üéì
                    </button>

                    <!-- Box 5: 4th Grade Science (Direct Link) - New Color, Corners, Emoji -->
                    <button 
                        data-grade="4th Grade Science"
                        data-path="4th Grade Science"
                        class="grade-btn text-white p-8 md:p-10 rounded-2xl shadow-md font-bold text-2xl md:text-3xl transition-all duration-300 ease-in-out transform hover:scale-105 hover:shadow-lg bg-purple-500 hover:bg-purple-600 sm:col-span-1">
                        4th Grade Science üß™
                    </button>
                </div>
            </div>

            <!-- ====================================================== -->
            <!-- == SUBJECT SCREEN (ELA / Math Selection) == -->
            <!-- ====================================================== -->
            <div id="subject-screen" class="hidden">
                
                <button id="back-to-grades-btn" class="absolute top-4 left-4 md:top-6 md:left-6 bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-xl transition-all hover:bg-slate-300">
                    &larr; Back
                </button>

                <header class="text-center mt-12 md:mt-0 animatable">
                    <h1 id="subject-title" class="text-3xl md:text-5xl font-bold text-slate-800"></h1>
                    <p class="text-lg md:text-xl text-slate-500 mt-3">
                        Please select a subject.
                    </p>
                </header>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-10 mt-10 md:mt-12 animatable">
                    
                    <button 
                        id="ela-btn"
                        data-subject="ELA"
                        class="subject-btn flex items-center justify-center text-center text-white p-16 md:p-24 rounded-2xl shadow-md font-bold text-4xl transition-all duration-300 ease-in-out transform hover:scale-105 hover:shadow-lg bg-sky-500 hover:bg-sky-600">
                        ELA üìö
                    </button>
                    
                    <button 
                        id="math-btn"
                        data-subject="Mathematics"
                        class="subject-btn flex items-center justify-center text-center text-white p-16 md:p-24 rounded-2xl shadow-md font-bold text-4xl transition-all duration-300 ease-in-out transform hover:scale-105 hover:shadow-lg bg-orange-500 hover:bg-orange-600">
                        Mathematics üßÆ
                    </button>
                </div>
            </div>

            <!-- ====================================================== -->
            <!-- == TEST SELECTION SCREEN == -->
            <!-- ====================================================== -->
            <div id="test-selection-screen" class="hidden">
                
                <button id="back-to-subjects-btn" class="absolute top-4 left-4 md:top-6 md:left-6 bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-xl transition-all hover:bg-slate-300">
                    &larr; Back
                </button>

                <header class="text-center mt-12 md:mt-0 animatable">
                    <h1 id="test-title" class="text-3xl md:text-5xl font-bold text-slate-800"></h1>
                    <p id="test-subtitle" class="text-lg md:text-xl text-slate-500 mt-3">
                        Please select a test.
                    </p>
                </header>

                <div id="loading-spinner" class="mt-12 flex justify-center items-center h-40">
                    <div class="loader loader-gray"></div>
                    <p class="ml-4 text-slate-600 text-lg">Loading Tests...</p>
                </div>

                <div id="test-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8 mt-10 md:mt-12 animatable">
                    <!-- Test buttons will be generated by JavaScript and inserted here -->
                </div>
                <p id="error-message" class="text-center text-red-500 mt-8 text-lg"></p>
            </div>

            <!-- ====================================================== -->
            <!-- == NEW SCREEN 4: TEST TAKER == -->
            <!-- ====================================================== -->
            <div id="test-taker-screen" class="hidden">
                <button id="back-to-tests-btn" class="absolute top-4 left-4 md:top-6 md:left-6 bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-xl transition-all hover:bg-slate-300">
                    &larr; Back to Tests
                </button>

                <header class="text-center mt-12 md:mt-0 animatable">
                    <h1 id="quiz-title" class="text-3xl md:text-5xl font-bold text-slate-800"></h1>
                    <p id="quiz-standard" class="text-lg md:text-xl text-slate-500 mt-3"></p>
                </header>

                <form id="quiz-form" class="mt-10 md:mt-12 space-y-8 animatable">
                    <!-- Quiz questions will be generated by JavaScript and inserted here -->
                    <!-- Example Question Structure:
                    <div class="bg-gray-50 p-6 rounded-2xl shadow-inner" id="question-0">
                        <p class="text-lg font-semibold text-slate-700">Question 1 of 10</p>
                        <p class="text-xl text-slate-800 mt-2">This is the question stem?</p>
                        <div class="space-y-3 mt-4">
                            <label class="flex items-center p-4 border rounded-xl has-[:checked]:bg-blue-100 has-[:checked]:border-blue-500">
                                <input type="radio" name="question-0" value="0" class="h-5 w-5 text-blue-600">
                                <span class="ml-4 text-lg text-slate-700">Option A</span>
                            </label>
                            <label class="flex items-center p-4 border rounded-xl has-[:checked]:bg-blue-100 has-[:checked]:border-blue-500">
                                <input type="radio" name="question-0" value="1" class="h-5 w-5 text-blue-600">
                                <span class="ml-4 text-lg text-slate-700">Option B</span>
                            </label>
                        </div>
                    </div>
                    -->
                </form>

                <button id="submit-test-btn" class="w-full mt-8 flex items-center justify-center gap-3 bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-6 rounded-xl shadow-md transition-all duration-300 transform hover:scale-105">
                    Submit Test for Grading
                </button>
                <p id="test-submit-message" class="text-center text-red-500 mt-4 h-6"></p>
            </div>

            <!-- ====================================================== -->
            <!-- == NEW SCREEN 5: SCORE SCREEN == -->
            <!-- ====================================================== -->
            <div id="score-screen" class="hidden">
                <header class="text-center animatable">
                    <h1 class="text-2xl md:text-4xl font-bold text-slate-800">
                        Test Submitted!
                    </h1>
                    <p class="text-6xl md:text-8xl font-bold text-blue-600 mt-6" id="final-score">
                        <!-- e.g., 8/10 -->
                    </p>
                    <p class="text-2xl md:text-3xl text-slate-600 mt-4" id="score-message">
                        <!-- e.g., Great job! -->
                    </p>
                </header>

                <!-- NEW AI Report Section -->
                <div id="ai-report-section" class="mt-12 animatable hidden">
                    <div class="bg-gray-50 p-6 rounded-2xl shadow-inner">
                        <h2 class="text-2xl font-bold text-slate-700">Your Personal Practice Plan ü§ñ</h2>
                        <p class="text-slate-600 mt-2">You missed a few questions on these skills. Here are some resources to help you master them!</p>
                        
                        <div id="ai-report-content" class="mt-6 space-y-4">
                            <!-- AI-generated content will go here -->
                        </div>
                        
                        <button id="get-ai-report-btn" class="w-full mt-6 flex items-center justify-center gap-3 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-xl shadow-md transition-all duration-300 transform hover:scale-105">
                            Generate My Practice Plan
                        </button>
                        <p id="ai-report-message" class="text-center text-slate-600 mt-4 h-6"></p>
                    </div>
                </div>

                <button id="back-to-home-btn" class="w-full mt-8 flex items-center justify-center gap-3 bg-slate-600 hover:bg-slate-700 text-white font-bold py-4 px-6 rounded-xl shadow-md transition-all duration-300 transform hover:scale-105">
                    Back to Home
                </button>
            </div>


        </div>
    </div>


    <!-- 3. JavaScript for Navigation AND AUTHENTICATION -->
    
    <!-- Import Firebase SDKs -->
    <script type="module">
        // Import functions from the Firebase SDKs
        // *** UPDATED Firebase version from 9.15.0 to 9.23.0 ***
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        // Import analytics
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js";
        // Import only the auth functions we need
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        // *** NEW *** Import Firestore functions
        import { 
            getFirestore, 
            doc, 
            getDoc,
            setDoc,        // <-- NEW: For creating user docs
            addDoc,        // <-- NEW: For saving submissions
            collection,    // <-- NEW: For saving submissions
            serverTimestamp  // <-- NEW: For timestamps
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // --- 1. FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBfvwMOWXRqN1QmFVoHJZo2mWvnrQMxm1k",
            authDomain: "scready-f7bc9.firebaseapp.com",
            projectId: "scready-f7bc9",
            storageBucket: "scready-f7bc9.appspot.com",
            messagingSenderId: "94383995704",
            appId: "1:94383995704:web:3a16a7cd3e74fabf34dfcd",
            measurementId: "G-CH5SBDKBEL"
        };

        // --- 2. GITHUB REPO CONFIGURATION ---
        // !! IMPORTANT !!
        // Replace this with the URL of your GitHub repository
        const GITHUB_REPO_URL = "https://github.com/YOUR_USERNAME/YOUR_REPO_NAME";
        
        const GITHUB_BRANCH = "main";
        
        let GITHUB_OWNER = 'YOUR_USERNAME';
        let GITHUB_REPO = 'YOUR_REPO_NAME';
        try {
            const urlParts = new URL(GITHUB_REPO_URL);
            const pathParts = urlParts.pathname.split('/').filter(Boolean); 
            if (pathParts.length >= 2) {
                GITHUB_OWNER = pathParts[0];
                GITHUB_REPO = pathParts[1];
            }
        } catch (e) {
            console.error("Could not parse GITHUB_REPO_URL. Please ensure it's a valid URL.");
        }
        
        const GITHUB_API_URL = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents`;
        // --- END CONFIGURATION ---

        
        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);

        
        // --- Get UI Elements ---
        const loginScreen = document.getElementById('login-screen');
        const mainContent = document.getElementById('main-content');
        
        const loginForm = document.getElementById('login-form');
        const loginEmail = document.getElementById('login-email');
        const loginPassword = document.getElementById('login-password');
        
        const logoutBtn = document.getElementById('logout-btn');
        const loginMessage = document.getElementById('login-message');
        
        // Dashboard Elements
        const teacherDashboardScreen = document.getElementById('teacher-dashboard-screen');
        const createStudentForm = document.getElementById('create-student-form');
        const studentEmail = document.getElementById('student-email');
        const studentPassword = document.getElementById('student-password');
        const createStudentBtn = document.getElementById('create-student-btn');
        const createStudentMessage = document.getElementById('create-student-message');

        // Student Screens
        const homeScreen = document.getElementById('home-screen');
        const subjectScreen = document.getElementById('subject-screen');
        const testSelectionScreen = document.getElementById('test-selection-screen');

        const gradeButtons = document.querySelectorAll('.grade-btn');
        const backToGradesBtn = document.getElementById('back-to-grades-btn');
        const subjectTitle = document.getElementById('subject-title');
        
        const subjectButtons = document.querySelectorAll('.subject-btn');

        // Test Screen Elements
        const backToSubjectsBtn = document.getElementById('back-to-subjects-btn');
        const testTitle = document.getElementById('test-title');
        const testSubtitle = document.getElementById('test-subtitle');
        const loadingSpinner = document.getElementById('loading-spinner');
        const testGrid = document.getElementById('test-grid');
        const errorMessage = document.getElementById('error-message');
        
        // ** NEW ** Test Taker Elements
        const testTakerScreen = document.getElementById('test-taker-screen');
        const backToTestsBtn = document.getElementById('back-to-tests-btn');
        const quizTitle = document.getElementById('quiz-title');
        const quizStandard = document.getElementById('quiz-standard');
        const quizForm = document.getElementById('quiz-form');
        const submitTestBtn = document.getElementById('submit-test-btn');
        const testSubmitMessage = document.getElementById('test-submit-message');

        // ** NEW ** Score Screen Elements
        const scoreScreen = document.getElementById('score-screen');
        const finalScore = document.getElementById('final-score');
        const scoreMessage = document.getElementById('score-message');
        const aiReportSection = document.getElementById('ai-report-section');
        const getAiReportBtn = document.getElementById('get-ai-report-btn');
        const aiReportContent = document.getElementById('ai-report-content');
        const aiReportMessage = document.getElementById('ai-report-message');
        const backToHomeBtn = document.getElementById('back-to-home-btn');
        
        // Animation collections
        const allScreens = [
            loginScreen, 
            teacherDashboardScreen, 
            homeScreen, 
            subjectScreen, 
            testSelectionScreen,
            testTakerScreen,
            scoreScreen
        ];
        
        // --- Global State Variables ---
        let currentGrade = '';
        let currentGradePath = '';
        let currentSubject = '';
        let currentQuizData = null; // Will hold the JSON for the active quiz
        let currentUserId = null; // Will hold the logged-in user's ID

        
        // --- 4. AUTHENTICATION LOGIC ---

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault(); 
            const email = loginEmail.value;
            const password = loginPassword.value;
            loginMessage.textContent = "Signing in...";

            signInWithEmailAndPassword(auth, email, password)
                .catch((error) => {
                    console.error("Sign-in error", error.code);
                    if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                        loginMessage.textContent = "Invalid email or password.";
                    } else {
                        loginMessage.textContent = "Sign-in failed. Please try again.";
                    }
                });
        });

        logoutBtn.addEventListener('click', () => {
            signOut(auth);
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid; // Store the user's ID globally
                checkUserRole(user);
            } else {
                currentUserId = null;
                showLoginScreen();
            }
        });

        async function checkUserRole(user) {
            loginMessage.textContent = "Checking authorization...";
            try {
                const docRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    const role = userData.role;

                    if (role === 'teacher') {
                        showTeacherDashboard();
                    } else if (role === 'student') {
                        showStudentContent();
                    } else {
                        loginMessage.textContent = "Your account has an invalid role.";
                        signOut(auth);
                    }
                } else {
                    loginMessage.textContent = "Your account is not configured. Please contact an administrator.";
                    signOut(auth);
                }
            } catch (error) {
                console.error("Error checking user role:", error);
                if (error.code === 'permission-denied' || (error.message && error.message.includes("permissions"))) {
                    loginMessage.textContent = "Error: Please check your Firestore Security Rules.";
                    console.log("FIX: Go to your Firestore 'Rules' tab and ensure you allow users to read their own document in the 'users' collection.");
                } else {
                    loginMessage.textContent = "An error occurred while checking your role.";
                }
                signOut(auth);
            }
        }

        // --- 5. SCREEN NAVIGATION LOGIC ---

        function showLoginScreen() {
            mainContent.classList.add('hidden');
            loginScreen.classList.remove('hidden');
            loginMessage.textContent = ""; 
        }

        function showTeacherDashboard() {
            loginScreen.classList.add('hidden');
            mainContent.classList.remove('hidden');
            loginMessage.textContent = "";
            animateScreenTransition(null, teacherDashboardScreen);
        }

        function showStudentContent() {
            loginScreen.classList.add('hidden');
            mainContent.classList.remove('hidden');
            loginMessage.textContent = "";
            animateScreenTransition(null, homeScreen);
        }

        /**
         * Helper function to manage animations and visibility
         * Pass `null` for screenToHide if it's the first screen.
         */
        function animateScreenTransition(screenToHide, screenToShow) {
            // Hide all screens first to prevent flashes
            allScreens.forEach(screen => {
                if(screen.id !== screenToShow.id) {
                     screen.classList.add('hidden');
                }
            });

            // If we are showing a screen inside the main content, ensure main content is visible
            if (screenToShow.id !== 'login-screen') {
                mainContent.classList.remove('hidden');
            }

            // Find animatable content in the new screen
            const animatables = screenToShow.querySelectorAll('.animatable');
            
            // Reset and trigger animation
            animatables.forEach(el => {
                el.classList.remove('pop-in'); 
                void el.offsetWidth; // Force browser reflow
                el.classList.add('pop-in'); 
            });

            screenToShow.classList.remove('hidden');
            window.scrollTo(0, 0);
        }
        
        // --- 6. STUDENT NAVIGATION LOGIC ---
        
        // Grade buttons navigate to Subject screen
        gradeButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                currentGrade = e.currentTarget.dataset.grade; 
                currentGradePath = e.currentTarget.dataset.path;
                
                // ** NEW ** Handle 4th Grade Science direct-to-test
                if (currentGradePath === "4th Grade Science") {
                    currentSubject = ""; // No subject for this one
                    testTitle.textContent = currentGrade;
                    testSubtitle.textContent = "Please select a test.";
                    fetchTestsFromGitHub(currentGradePath); // Directly fetch tests
                    animateScreenTransition(homeScreen, testSelectionScreen);
                } else {
                    // Normal flow: show subject screen
                    subjectTitle.textContent = currentGrade;
                    animateScreenTransition(homeScreen, subjectScreen);
                }
            });
        });

        // Subject buttons navigate to Test screen
        subjectButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                currentSubject = e.currentTarget.dataset.subject;
                
                // e.g., "3rd Grade - ELA"
                testTitle.textContent = `${currentGrade} - ${currentSubject}`;
                testSubtitle.textContent = "Please select a test.";
                
                // Build the final path, e.g., "3rd/ELA"
                const dataPath = `${currentGradePath}/${currentSubject}`;
                fetchTestsFromGitHub(dataPath);
                animateScreenTransition(subjectScreen, testSelectionScreen);
            });
        });

        // Back buttons
        backToGradesBtn.addEventListener('click', () => animateScreenTransition(subjectScreen, homeScreen));
        backToSubjectsBtn.addEventListener('click', () => {
             // ** NEW ** Smart back button
             if (currentGradePath === "4th Grade Science") {
                animateScreenTransition(testSelectionScreen, homeScreen); // Go all the way home
             } else {
                animateScreenTransition(testSelectionScreen, subjectScreen); // Go to subjects
             }
        });
        backToTestsBtn.addEventListener('click', () => animateScreenTransition(testTakerScreen, testSelectionScreen));
        backToHomeBtn.addEventListener('click', () => animateScreenTransition(scoreScreen, homeScreen));
        

        /**
         * ** NEW **
         * Fetches tests from GitHub and populates the test grid
         */
        async function fetchTestsFromGitHub(dataPath) {
            errorMessage.textContent = ""; 
            testGrid.innerHTML = ''; // Clear old tests
            loadingSpinner.classList.remove('hidden'); // Show loading

            const apiUrl = `${GITHUB_API_URL}/${dataPath}?ref=${GITHUB_BRANCH}`;

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`Folder not found (404). Check your repo structure.`);
                }
                const items = await response.json();
                
                // ** NEW ** Filter for .json files only
                const tests = items.filter(item => item.type === 'file' && item.name.endsWith('.json'));

                if (tests.length === 0) {
                    testSubtitle.textContent = "No tests found in this folder.";
                } else {
                    testSubtitle.textContent = "Please select a test.";
                    // Populate the grid with test buttons
                    tests.forEach(item => {
                        const testButton = document.createElement('button');
                        // Store the raw download URL
                        testButton.dataset.downloadUrl = item.download_url;
                        
                        // Clean up the name (e.g., "Test_1.json" -> "Test 1")
                        const displayName = item.name.replace(/_/g, ' ').replace(/\.json$/i, '');
                        
                        testButton.textContent = displayName;
                        testButton.className = "test-btn flex items-center justify-center text-center text-white p-8 rounded-2xl shadow-md font-bold text-xl transition-all duration-300 ease-in-out transform hover:scale-105 hover:shadow-lg bg-slate-600 hover:bg-slate-700";
                        
                        // ** NEW ** Add click listener to start the test
                        testButton.addEventListener('click', () => startTest(item.download_url));
                        
                        testGrid.appendChild(testButton);
                    });
                }

            } catch (error) {
                console.error("Error fetching GitHub tests:", error);
                errorMessage.textContent = `Error loading tests. (${error.message})`;
            } finally {
                loadingSpinner.classList.add('hidden'); // Hide spinner
            }
        }
        
        // --- 7. ** NEW ** TEST TAKER LOGIC ---
        
        /**
         * Fetches the quiz JSON and renders the test
         */
        async function startTest(downloadUrl) {
            // Show loading state...
            quizForm.innerHTML = '<div class="loader loader-gray mx-auto"></div>';
            quizTitle.textContent = "Loading Test...";
            quizStandard.textContent = "";
            testSubmitMessage.textContent = "";
            animateScreenTransition(testSelectionScreen, testTakerScreen);

            try {
                const response = await fetch(downloadUrl);
                if (!response.ok) throw new Error("Could not download test file.");
                
                const quizData = await response.json();
                currentQuizData = quizData; // Save quiz data globally
                renderTest(quizData);
                
            } catch (error) {
                console.error("Error starting test:", error);
                quizForm.innerHTML = `<p class="text-red-500 text-center">Error: Could not load this test. Please go back and try again.</p>`;
            }
        }

        /**
         * Builds the quiz HTML from the JSON data
         */
        function renderTest(quizData) {
            quizForm.innerHTML = ''; // Clear loading spinner
            quizTitle.textContent = quizData.title;
            quizStandard.textContent = `Standard: ${quizData.standard}`;

            // Loop through questions and build HTML
            quizData.questions.forEach((question, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.id = `question-${index}`;
                questionDiv.className = "bg-gray-50 p-6 rounded-2xl shadow-inner";
                
                let optionsHtml = '';
                // TODO: Add support for other question types (EBSR, etc.)
                if (question.type === "Multiple-Choice") {
                    const optionsArray = question.options.map((option, i) => `
                        <label class="flex items-center p-4 border rounded-xl has-[:checked]:bg-blue-100 has-[:checked]:border-blue-500 cursor-pointer">
                            <input type="radio" name="question-${index}" value="${i}" class="h-5 w-5 text-blue-600" required>
                            <span class="ml-4 text-lg text-slate-700">${option}</span>
                        </label>
                    `).join('');
                    
                    optionsHtml = `<div class="space-y-3 mt-4">${optionsArray}</div>`;
                }
                
                questionDiv.innerHTML = `
                    <p class="text-lg font-semibold text-slate-700">Question ${index + 1} of ${quizData.questions.length}</p>
                    ${question.stimulus ? `<div class="text-lg text-slate-800 mt-4 p-4 border-l-4 border-gray-300">${question.stimulus}</div>` : ''}
                    <p class="text-xl text-slate-900 mt-4">${question.stem}</p>
                    ${optionsHtml}
                `;
                quizForm.appendChild(questionDiv);
            });
        }
        
        // Add submit listener to the form
        quizForm.addEventListener('submit', (e) => {
            e.preventDefault();
            handleSubmitTest();
        });
        
        // The submit button is outside the form, so we trigger the form's submit event
        submitTestBtn.addEventListener('click', () => {
            // Check if form is valid before submitting
            if (quizForm.checkValidity()) {
                quizForm.requestSubmit();
            } else {
                testSubmitMessage.textContent = "Please answer all questions before submitting.";
            }
        });

        /**
         * Grades the test and saves the score
         */
        async function handleSubmitTest() {
            if (!currentQuizData || !currentUserId) return;

            let score = 0;
            const failedSkills = new Set();
            const formData = new FormData(quizForm);

            currentQuizData.questions.forEach((question, index) => {
                const selectedAnswer = formData.get(`question-${index}`); // This will be a string "0", "1", etc.
                
                // Note: Using == to compare string from form with number from JSON
                if (selectedAnswer == question.correctAnswerIndex) {
                    score++;
                } else {
                    // Track the skill for the AI report
                    if(question.skill) {
                        failedSkills.add(question.skill);
                    }
                }
            });

            const total = currentQuizData.questions.length;
            const percentage = Math.round((score / total) * 100);

            // Display the score screen
            finalScore.textContent = `${score} / ${total}`;
            if (percentage >= currentQuizData.passingScore) {
                scoreMessage.textContent = `Congratulations, you passed! (${percentage}%)`;
                aiReportSection.classList.add('hidden'); // Hide AI report
            } else {
                scoreMessage.textContent = `Don't give up, you'll get it next time! (${percentage}%)`;
                aiReportSection.classList.remove('hidden'); // Show AI report
            }
            animateScreenTransition(testTakerScreen, scoreScreen);

            // Save the score to Firestore
            try {
                const submissionsRef = collection(db, "submissions");
                await addDoc(submissionsRef, {
                    studentId: currentUserId,
                    testTitle: currentQuizData.title,
                    testStandard: currentQuizData.standard,
                    score: score,
                    totalQuestions: total,
                    percentage: percentage,
                    failedSkills: Array.from(failedSkills),
                    submittedAt: serverTimestamp()
                });
            } catch (error) {
                console.error("Error saving submission:", error);
                // Don't block the user, just log the error
            }
        }
        
        // Placeholder for AI Report Button
        getAiReportBtn.addEventListener('click', () => {
            aiReportMessage.textContent = "Generating your report... (AI feature coming soon!)";
            // In the future, this will call a Firebase Function
            // and pass it the `failedSkills` array.
        });


        // --- 8. ** NEW ** TEACHER DASHBOARD LOGIC ---
        
        createStudentForm.addEventListener('submit', (e) => {
            e.preventDefault();
            createStudentMessage.textContent = "Connecting to backend...";

            // !! IMPORTANT !!
            // This functionality requires a Firebase Function to work securely.
            console.log("Form submitted. This will call a Firebase Function.");

            // Simulate a delay and show a message
            setTimeout(() => {
                // This is a placeholder. We will build the function next.
                createStudentMessage.textContent = "Error: Backend function not deployed.";
            }, 1000);
        });

    </script>

</body>
</html>


