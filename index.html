<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SC Ready Practice Test</title>
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 2. Use a clean, modern font (Changed to Poppins) */
        body {
            font-family: 'Poppins', sans-serif;
        }
        /* Added for the Poppins font */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap');

        /* 3. Added Pop-in Animation */
        @keyframes pop-in {
            0% {
                transform: scale(0.95);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .pop-in {
            /* Animation applied by JavaScript */
            animation: pop-in 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        /* 4. Added Loading Spinner */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            width: 2.5rem;
            height: 2.5rem;
            animation: spin 1s linear infinite;
        }
        .loader-gray {
            border-top-color: #4b5563; /* gray-600 */
        }

        /* * ** FIX APPLIED HERE **
         * Removed all Tailwind @apply rules.
         * These styles are now applied directly in the JavaScript renderTest function.
         */

        /* ** NEW ** Styles for AI Report */
        .ai-report-content h3 {
            @apply text-xl font-bold text-slate-800 mt-4;
        }
        .ai-report-content ul {
            @apply list-disc list-inside space-y-2 mt-2;
        }
        .ai-report-content li {
            @apply text-slate-700;
        }
        .ai-report-content a {
            @apply text-blue-600 hover:underline;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- ====================================================== -->
    <!-- == SCREEN 1: LOGIN (New) == -->
    <!-- ====================================================== -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4 md:p-8">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-10 text-center pop-in">
            <h1 class="text-3xl font-bold text-slate-800">
                SC Ready Practice Test ‚úèÔ∏è
            </h1>
            <p class="text-lg text-slate-500 mt-3">
                Please sign in with your account to continue.
            </p>
            
            <form id="login-form" class="mt-8 space-y-4">
                <div>
                    <input id="login-email" type="email" placeholder="Email" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <input id="login-password" type="password" placeholder="Password" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <button type="submit" id="login-btn" class="w-full flex items-center justify-center gap-3 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-xl shadow-md transition-all duration-300 transform hover:scale-105">
                    Sign In
                </button>
            </form>
            
            <p id="login-message" class="text-red-500 mt-4 h-6"></p>
        </div>
    </div>


    <!-- ====================================================== -->
    <!-- == SCREEN 2: MAIN CONTENT (Hidden by default) == -->
    <!-- ====================================================== -->
    <div id="main-content" class="min-h-screen flex items-center justify-center p-4 md:p-8 hidden">

        <div class="w-full max-w-5xl bg-white rounded-2xl shadow-xl p-6 md:p-10 relative overflow-hidden">

            <button id="logout-btn" class="absolute z-10 top-4 right-4 md:top-6 md:right-6 bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-xl transition-all hover:bg-slate-300">
                Sign Out
            </button>

            <!-- ====================================================== -->
            <!-- == TEACHER DASHBOARD SCREEN == -->
            <!-- ====================================================== -->
            <div id="teacher-dashboard-screen" class="hidden">
                <header class="text-center animatable">
                    <h1 class="text-3xl md:text-5xl font-bold text-slate-800">
                        Teacher Dashboard üë©‚Äçüè´
                    </h1>
                    <p class="text-lg md:text-xl text-slate-500 mt-3">
                        Manage your students and view scores.
                    </p>
                </header>

                <div class="mt-10 md:mt-12 grid grid-cols-1 md:grid-cols-2 gap-8">
                    
                    <div class="bg-gray-50 p-6 rounded-2xl shadow-inner">
                        <h2 class="text-2xl font-bold text-slate-700">Create Student Account</h2>
                        <form id="create-student-form" class="mt-4 space-y-4">
                            <div>
                                <label for="student-email" class="block text-sm font-medium text-gray-700">Student Email</label>
                                <input id="student-email" type="email" placeholder="student@email.com" required class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="student-password" class="block text-sm font-medium text-gray-700">Temporary Password</label>
                                <input id="student-password" type="password" placeholder="At least 6 characters" required class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <button type="submit" id="create-student-btn" class="w-full flex items-center justify-center gap-3 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-xl shadow-md transition-all duration-300 transform hover:scale-105">
                                Create Student
                            </button>
                        </form>
                        <p id="create-student-message" class="text-sm mt-3 h-4"></p>
                    </div>

                    <div class="bg-gray-50 p-6 rounded-2xl shadow-inner">
                        <div class="flex justify-between items-center">
                            <h2 class="text-2xl font-bold text-slate-700">Student Scores</h2>
                            <button id="refresh-scores-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-xl transition-all text-sm">
                                Refresh
                            </button>
                        </div>
                        
                        <!-- ** MODIFIED ** Scores list now uses grouping structure -->
                        <div id="scores-list-container" class="mt-4 space-y-3 max-h-60 overflow-y-auto">
                            <p id="scores-message" class="text-slate-500">Click "Refresh" to load scores.</p>
                        </div>
                        
                        <p id="reset-message" class="text-sm mt-3 h-4"></p>
                    </div>
                </div>
            </div>

            <!-- ====================================================== -->
            <!-- == HOME SCREEN (Grade Selection) == -->
            <!-- ====================================================== -->
            <div id="home-screen" class="hidden">
                <header class="text-center animatable">
                    <h1 class="text-3xl md:text-5xl font-bold text-slate-800">
                        SC Ready Practice Test ‚úèÔ∏è
                    </h1>
                    <p class="text-lg md:text-xl text-slate-500 mt-3">
                        Please select a grade level to begin.
                    </I>
                </header>

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8 mt-10 md:mt-12 animatable">
                    
                    <button 
                        data-grade="3rd Grade" 
                        data-path="3rd"
                        class="grade-btn text-white p-8 md:p-10 rounded-2xl shadow-md font-bold text-2xl md:text-3xl transition-all duration-300 ease-in-out transform hover:scale-105 hover:shadow-lg bg-blue-500 hover:bg-blue-600">
                        3rd Grade ü•â 
                    </button>

                    <button 
                        data-grade="4th Grade" 
                        data-path="4th"
                        class="grade-btn text-white p-8 md:p-10 rounded-2xl shadow-md font-bold text-2xl md:text-3xl transition-all duration-300 ease-in-out transform hover:scale-105 hover:shadow-lg bg-yellow-500 hover:bg-yellow-600">
                        4th Grade ü•à
                    </button>

                    <button 
                        data-grade="5th Grade" 
                        data-path="5th"
                        class="grade-btn text-white p-8 md:p-10 rounded-2xl shadow-md font-bold text-2xl md:text-3xl transition-all duration-300 ease-in-out transform hover:scale-105 hover:shadow-lg bg-green-500 hover:bg-green-600">
                        5th Grade ü•á
                    </button>

                    <button 
                        data-grade="6th Grade" 
                        data-path="6th"
                        class="grade-btn text-white p-8 md:p-10 rounded-2xl shadow-md font-bold text-2xl md:text-3xl transition-all duration-300 ease-in-out transform hover:scale-105 hover:shadow-lg bg-red-500 hover:bg-red-600">
                        6th Grade üéì
                    </button>

                    <button 
                        data-grade="4th Grade Science"
                        data-path="4th Grade Science"
                        class="grade-btn text-white p-8 md:p-10 rounded-2xl shadow-md font-bold text-2xl md:text-3xl transition-all duration-300 ease-in-out transform hover:scale-105 hover:shadow-lg bg-purple-500 hover:bg-purple-600 sm:col-span-1">
                        4th Grade Science üß™
                    </button>
                </div>
            </div>

            <!-- ====================================================== -->
            <!-- == SUBJECT SCREEN (ELA / Math Selection) == -->
            <!-- ====================================================== -->
            <div id="subject-screen" class="hidden">
                
                <button id="back-to-grades-btn" class="absolute z-10 top-4 left-4 md:top-6 md:left-6 bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-xl transition-all hover:bg-slate-300">
                    &larr; Back
                </button>

                <header class="text-center mt-12 md:mt-0 animatable">
                    <h1 id="subject-title" class="text-3xl md:text-5xl font-bold text-slate-800"></h1>
                    <p class="text-lg md:text-xl text-slate-500 mt-3">
                        Please select a subject.
                    </p>
                </header>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-10 mt-10 md:mt-12 animatable">
                    
                    <button 
                        id="ela-btn"
                        data-subject="ELA"
                        class="subject-btn flex items-center justify-center text-center text-white p-16 md:p-24 rounded-2xl shadow-md font-bold text-4xl transition-all duration-300 ease-in-out transform hover:scale-105 hover:shadow-lg bg-sky-500 hover:bg-sky-600">
                        ELA üìö
                    </button>
                    
                    <button 
                        id="math-btn"
                        data-subject="Mathematics"
                        class="subject-btn flex items-center justify-center text-center text-white p-16 md:p-24 rounded-2xl shadow-md font-bold text-4xl transition-all duration-300 ease-in-out transform hover:scale-105 hover:shadow-lg bg-orange-500 hover:bg-orange-600">
                        Mathematics üßÆ
                    </button>
                </div>
            </div>

            <!-- ====================================================== -->
            <!-- == TEST SELECTION SCREEN == -->
            <!-- ====================================================== -->
            <div id="test-selection-screen" class="hidden">
                
                <button id="back-to-subjects-btn" class="absolute z-10 top-4 left-4 md:top-6 md:left-6 bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-xl transition-all hover:bg-slate-300">
                    &larr; Back
                </button>

                <header class="text-center mt-12 md:mt-0 animatable">
                    <h1 id="test-title" class="text-3xl md:text-5xl font-bold text-slate-800"></h1>
                    <p id="test-subtitle" class="text-lg md:text-xl text-slate-500 mt-3">
                        Please select a test.
                    </p>
                </header>

                <div id="loading-spinner" class="mt-12 flex justify-center items-center h-40">
                    <div class="loader loader-gray"></div>
                    <p class="ml-4 text-slate-600 text-lg">Loading Tests...</p>
                </div>

                <div id="test-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8 mt-10 md:mt-12 animatable">
                    <!-- Test buttons will be generated by JavaScript and inserted here -->
                </div>
                <p id="error-message" class="text-center text-red-500 mt-8 text-lg"></p>
            </div>

            <!-- ====================================================== -->
            <!-- == NEW SCREEN 4: TEST TAKER == -->
            <!-- ====================================================== -->
            <div id="test-taker-screen" class="hidden">
                <button id="back-to-tests-btn" class="absolute z-10 top-4 left-4 md:top-6 md:left-6 bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-xl transition-all hover:bg-slate-300">
                    &larr; Back to Tests
                </button>

                <header class="text-center mt-12 md:mt-0 animatable">
                    <h1 id="quiz-title" class="text-3xl md:text-5xl font-bold text-slate-800"></h1>
                    <p id="quiz-standard" class="text-lg md:text-xl text-slate-500 mt-3"></p>
                </header>

                <form id="quiz-form" class="mt-10 md:mt-12 animatable min-h-[200px]">
                    <!-- Quiz questions will be generated by JavaScript and inserted here -->
                </form>

                <div id="quiz-navigation" class="mt-8 flex justify-between items-center">
                    <button id="prev-question-btn" class="bg-slate-500 hover:bg-slate-600 text-white font-bold py-3 px-6 rounded-xl shadow-md transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                        &larr; Previous
                    </button>
                    
                    <p id="question-counter" class="text-slate-600 font-semibold"></p>
                    
                    <button id="next-question-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-xl shadow-md transition-all duration-300">
                        Next &rarr;
                    </button>
                    
                    <button id="submit-test-btn" class="w-auto hidden flex items-center justify-center gap-3 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-xl shadow-md transition-all duration-300 transform hover:scale-105">
                        Submit Test for Grading
                    </button>
                </div>
                <p id="test-submit-message" class="text-center text-red-500 mt-4 h-6"></p>
            </div>

            <!-- ====================================================== -->
            <!-- == NEW SCREEN 5: SCORE SCREEN == -->
            <!-- ====================================================== -->
            <div id="score-screen" class="hidden">
                <header class="text-center animatable">
                    <h1 class="text-2xl md:text-4xl font-bold text-slate-800">
                        Test Submitted!
                    </h1>
                    <p class="text-6xl md:text-8xl font-bold text-blue-600 mt-6" id="final-score">
                        <!-- e.g., 8/10 -->
                    </p>
                    <p class="text-2xl md:text-3xl text-slate-600 mt-4" id="score-message">
                        <!-- e.g., Great job! -->
                    </p>
                </header>

                <!-- ** MODIFIED ** AI Report Section -->
                <div id="ai-report-section" class="mt-12 animatable hidden">
                    <div class="bg-gray-50 p-6 rounded-2xl shadow-inner">
                        <h2 class="text-2xl font-bold text-slate-700">What to do now? ü§ñ</h2>
                        <p class="text-slate-600 mt-2">You missed a few questions on these skills. Here are some resources to help you master them!</p>
                        
                        <!-- ** MODIFIED ** This is where the AI content will be injected -->
                        <div id="ai-report-content" class="mt-6 space-y-4 ai-report-content">
                            <!-- AI-generated content will go here -->
                        </div>
                        
                        <!-- ** MODIFIED ** Changed button text -->
                        <button id="get-ai-report-btn" class="w-full mt-6 flex items-center justify-center gap-3 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-xl shadow-md transition-all duration-300 transform hover:scale-105">
                            Get My Practice Plan
                        </button>
                        <p id="ai-report-message" class="text-center text-slate-600 mt-4 h-6"></p>
                    </div>
                </div>

                <button id="back-to-home-btn" class="w-full mt-8 flex items-center justify-center gap-3 bg-slate-600 hover:bg-slate-700 text-white font-bold py-4 px-6 rounded-xl shadow-md transition-all duration-300 transform hover:scale-105">
                    Back to Home
                </button>
            </div>


        </div>
    </div>


    <!-- 3. JavaScript for Navigation AND AUTHENTICATION -->
    
    <script type="module">
        // Import functions from the Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        
        // ** MODIFIED ** Import more Firestore functions
        import { 
            getFirestore, 
            doc, 
            getDoc,
            addDoc,
            collection,
            serverTimestamp,
            query,
            where, // ** NEW ** Added for test locking
            getDocs,
            deleteDoc
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        
        // ** NEW ** Import Firebase Functions
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-functions.js";


        // --- 1. FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBfvwMOWXRqN1QmFVoHJZo2mWvnrQMxm1k",
            authDomain: "scready-f7bc9.firebaseapp.com",
            projectId: "scready-f7bc9",
            storageBucket: "scready-f7bc9.appspot.com",
            messagingSenderId: "94383995704",
            appId: "1:94383995704:web:3a16a7cd3e74fabf34dfcd",
            measurementId: "G-CH5SBDKBEL"
        };

        // --- 2. GITHUB REPO CONFIGURATION ---
        const GITHUB_REPO_URL = "https://github.com/stevenraymond8592-create/scready";
        const GITHUB_BRANCH = "main";
        
        let GITHUB_OWNER = 'YOUR_USERNAME';
        let GITHUB_REPO = 'YOUR_REPO_NAME';
        try {
            const urlParts = new URL(GITHUB_REPO_URL);
            const pathParts = urlParts.pathname.split('/').filter(Boolean); 
            if (pathParts.length >= 2) {
                GITHUB_OWNER = pathParts[0];
                GITHUB_REPO = pathParts[1];
            }
        } catch (e) {
            console.error("Could not parse GITHUB_REPO_URL. Please ensure it's a valid URL.");
        }
        
        const GITHUB_API_URL = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents`;
        // --- END CONFIGURATION ---

        
        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const functions = getFunctions(app); // ** NEW ** Initialize Functions

        
        // --- Get UI Elements ---
        const loginScreen = document.getElementById('login-screen');
        const mainContent = document.getElementById('main-content');
        
        const loginForm = document.getElementById('login-form');
        const loginEmail = document.getElementById('login-email');
        const loginPassword = document.getElementById('login-password');
        
        const logoutBtn = document.getElementById('logout-btn');
        const loginMessage = document.getElementById('login-message');
        
        // Dashboard Elements
        const teacherDashboardScreen = document.getElementById('teacher-dashboard-screen');
        const createStudentForm = document.getElementById('create-student-form');
        const studentEmail = document.getElementById('student-email');
        const studentPassword = document.getElementById('student-password');
        const createStudentBtn = document.getElementById('create-student-btn');
        const createStudentMessage = document.getElementById('create-student-message');
        const refreshScoresBtn = document.getElementById('refresh-scores-btn');
        const scoresListContainer = document.getElementById('scores-list-container');
        const scoresMessage = document.getElementById('scores-message');
        const resetMessage = document.getElementById('reset-message');


        // Student Screens
        const homeScreen = document.getElementById('home-screen');
        const subjectScreen = document.getElementById('subject-screen');
        const testSelectionScreen = document.getElementById('test-selection-screen');

        const gradeButtons = document.querySelectorAll('.grade-btn');
        const backToGradesBtn = document.getElementById('back-to-grades-btn');
        const subjectTitle = document.getElementById('subject-title');
        
        const subjectButtons = document.querySelectorAll('.subject-btn');

        // Test Screen Elements
        const backToSubjectsBtn = document.getElementById('back-to-subjects-btn');
        const testTitle = document.getElementById('test-title');
        const testSubtitle = document.getElementById('test-subtitle');
        const loadingSpinner = document.getElementById('loading-spinner');
        const testGrid = document.getElementById('test-grid');
        const errorMessage = document.getElementById('error-message');
        
        // Test Taker Elements
        const testTakerScreen = document.getElementById('test-taker-screen');
        const backToTestsBtn = document.getElementById('back-to-tests-btn');
        const quizTitle = document.getElementById('quiz-title');
        const quizStandard = document.getElementById('quiz-standard');
        const quizForm = document.getElementById('quiz-form');
        const submitTestBtn = document.getElementById('submit-test-btn');
        const testSubmitMessage = document.getElementById('test-submit-message');
        const quizNavigation = document.getElementById('quiz-navigation');
        const prevQuestionBtn = document.getElementById('prev-question-btn');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const questionCounter = document.getElementById('question-counter');


        // Score Screen Elements
        const scoreScreen = document.getElementById('score-screen');
        const finalScore = document.getElementById('final-score');
        const scoreMessage = document.getElementById('score-message');
        const aiReportSection = document.getElementById('ai-report-section');
        const getAiReportBtn = document.getElementById('get-ai-report-btn');
        const aiReportContent = document.getElementById('ai-report-content');
        const aiReportMessage = document.getElementById('ai-report-message');
        const backToHomeBtn = document.getElementById('back-to-home-btn');
        
        // Animation collections
        const allScreens = [
            loginScreen, 
            teacherDashboardScreen, 
            homeScreen, 
            subjectScreen, 
            testSelectionScreen,
            testTakerScreen,
            scoreScreen
        ];
        
        // --- Global State Variables ---
        let currentGrade = '';
        let currentGradePath = '';
        let currentSubject = '';
        let currentQuizData = null; 
        let currentUserId = null; 
        let currentQuestionIndex = 0;
        let currentFailedSkills = []; // ** NEW ** For AI report
        
        // ** NEW ** Holds a map of test titles the student has completed
        let studentSubmissions = {}; 
        
        let draggedItem = null;


        
        // --- 4. AUTHENTICATION LOGIC ---

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault(); 
            const email = loginEmail.value;
            const password = loginPassword.value;
            loginMessage.textContent = "Signing in...";

            signInWithEmailAndPassword(auth, email, password)
                .catch((error) => {
                    console.error("Sign-in error", error.code);
                    if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                        loginMessage.textContent = "Invalid email or password.";
                    } else {
                        loginMessage.textContent = "Sign-in failed. Please try again.";
                    }
                });
        });

        logoutBtn.addEventListener('click', () => {
            signOut(auth);
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid; 
                checkUserRole(user);
            } else {
                currentUserId = null;
                showLoginScreen();
            }
        });

        async function checkUserRole(user) {
            loginMessage.textContent = "Checking authorization...";
            try {
                const docRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    const role = userData.role;

                    if (role === 'teacher') {
                        showTeacherDashboard();
                    } else if (role === 'student') {
                        showStudentContent();
                    } else {
                        loginMessage.textContent = "Your account has an invalid role.";
                        signOut(auth);
                    }
                } else {
                    loginMessage.textContent = "Your account is not configured. Please contact an administrator.";
                    signOut(auth);
                }
            } catch (error) {
                console.error("Error checking user role:", error);
                if (error.code === 'permission-denied' || (error.message && error.message.includes("permissions"))) {
                    loginMessage.textContent = "Error: Please check your Firestore Security Rules.";
                    console.log("FIX: Go to your Firestore 'Rules' tab and ensure you allow users to read their own document in the 'users' collection.");
                } else {
                    loginMessage.textContent = "An error occurred while checking your role.";
                }
                signOut(auth);
            }
        }

        // --- 5. SCREEN NAVIGATION LOGIC ---

        function showLoginScreen() {
            mainContent.classList.add('hidden');
            loginScreen.classList.remove('hidden');
            loginMessage.textContent = ""; 
        }

        function showTeacherDashboard() {
            loginScreen.classList.add('hidden');
            mainContent.classList.remove('hidden');
            loginMessage.textContent = "";
            animateScreenTransition(null, teacherDashboardScreen);
            
            fetchStudentScores();
        }

        function showStudentContent() {
            loginScreen.classList.add('hidden');
            mainContent.classList.remove('hidden');
            loginMessage.textContent = "";
            animateScreenTransition(null, homeScreen);
        }

        function animateScreenTransition(screenToHide, screenToShow) {
            allScreens.forEach(screen => {
                if(screen.id !== screenToShow.id) {
                     screen.classList.add('hidden');
                }
            });

            if (screenToShow.id !== 'login-screen') {
                mainContent.classList.remove('hidden');
            }

            const animatables = screenToShow.querySelectorAll('.animatable');
            
            animatables.forEach(el => {
                el.classList.remove('pop-in'); 
                void el.offsetWidth; // Force browser reflow
                el.classList.add('pop-in'); 
            });

            screenToShow.classList.remove('hidden');
            window.scrollTo(0, 0);
        }
        
        // --- 6. STUDENT NAVIGATION LOGIC ---
        
        gradeButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                currentGrade = e.currentTarget.dataset.grade; 
                currentGradePath = e.currentTarget.dataset.path;
                
                if (currentGradePath === "4th Grade Science") {
                    currentSubject = ""; 
                    testTitle.textContent = currentGrade;
                    testSubtitle.textContent = "Please select a test.";
                    fetchTestsFromGitHub(currentGradePath); 
                    animateScreenTransition(homeScreen, testSelectionScreen);
                } else {
                    subjectTitle.textContent = currentGrade;
                    animateScreenTransition(homeScreen, subjectScreen);
                }
            });
        });

        subjectButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                currentSubject = e.currentTarget.dataset.subject;
                
                testTitle.textContent = `${currentGrade} - ${currentSubject}`;
                testSubtitle.textContent = "Please select a test.";
                
                const dataPath = `${currentGradePath}/${currentSubject}`;
                fetchTestsFromGitHub(dataPath);
                animateScreenTransition(subjectScreen, testSelectionScreen);
            });
        });

        // Back buttons
        backToGradesBtn.addEventListener('click', () => animateScreenTransition(subjectScreen, homeScreen));
        backToSubjectsBtn.addEventListener('click', () => {
             if (currentGradePath === "4th Grade Science") {
                animateScreenTransition(testSelectionScreen, homeScreen); 
             } else {
                animateScreenTransition(testSelectionScreen, subjectScreen);
             }
        });
        backToTestsBtn.addEventListener('click', () => {
            submitTestBtn.classList.add('hidden');
            nextQuestionBtn.classList.remove('hidden');
            // ** NEW ** Re-fetch tests to show locked status
            fetchTestsFromGitHub(`${currentGradePath}/${currentSubject}`);
            animateScreenTransition(testTakerScreen, testSelectionScreen);
        });
        backToHomeBtn.addEventListener('click', () => {
            // ** NEW ** Go to test selection, not home, to see locked status
            fetchTestsFromGitHub(`${currentGradePath}/${currentSubject}`);
            animateScreenTransition(scoreScreen, testSelectionScreen);
        });
        

        /**
         * ** MODIFIED **
         * Now fetches student's completed tests to "lock" them.
         */
        async function fetchTestsFromGitHub(dataPath) {
            errorMessage.textContent = ""; 
            testGrid.innerHTML = ''; 
            loadingSpinner.classList.remove('hidden');
            
            // ** NEW ** Step 1: Get all submissions for the current student
            studentSubmissions = {}; // Clear previous
            if (currentUserId) {
                try {
                    const submissionsRef = collection(db, "submissions");
                    const q = query(submissionsRef, where("studentId", "==", currentUserId));
                    const querySnapshot = await getDocs(q);
                    
                    querySnapshot.forEach((doc) => {
                        studentSubmissions[doc.data().testTitle] = true;
                    });
                } catch (e) {
                    console.error("Could not fetch student submissions:", e);
                    errorMessage.textContent = "Error checking your completed tests.";

                    // ** START FIX **
                    // Add specific error help for permissions
                    if (e.code === 'permission-denied') {
                        errorMessage.innerHTML = `<span class="font-bold text-red-600">Error: Permission Denied.</span><br>Your app can't check for completed tests. You must update your Firestore Rules.`;
                        console.log("--- FIX FOR STUDENT PERMISSION DENIED ---");
                        console.log("Go to your Firebase Project -> Firestore Database -> Rules tab.");
                        console.log("You need to allow students to read their OWN submissions.");
                        console.log("Your 'submissions' rule block should look like this:");
                        console.log(`
    match /submissions/{submissionId} {
      // Students can create their own submissions
      allow create: if request.auth != null && request.resource.data.studentId == request.auth.uid;
      
      // Teachers can read, list (query), and delete
      allow read, list, delete: if request.auth != null 
                              && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'teacher';
      
      // Students can read their own documents
      allow read: if request.auth != null && request.auth.uid == resource.data.studentId;

      // Students can list (query) their own documents
      allow list: if request.auth != null && request.query.where.length > 0 && request.query.where[0][0] == 'studentId' && request.query.where[0][2] == request.auth.uid;
      
      // No one can update
      allow update: if false;
    }
                        `);
                        console.log("--- END OF FIX ---");
                    }
                    // ** END FIX **
                }
            }
            
            // Step 2: Fetch tests from GitHub
            const apiUrl = `${GITHUB_API_URL}/${dataPath}?ref=${GITHUB_BRANCH}`;
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`Folder not found (404). Check your repo structure.`);
                }
                const items = await response.json();
                
                const tests = items.filter(item => item.type === 'file' && item.name.endsWith('.json'));

                if (tests.length === 0) {
                    testSubtitle.textContent = "No tests found in this folder.";
                } else {
                    testSubtitle.textContent = "Please select a test.";
                    
                    // ** NEW ** Step 3: Build buttons, checking against submissions
                    tests.forEach(item => {
                        const testButton = document.createElement('button');
                        testButton.dataset.downloadUrl = item.download_url;
                        
                        const displayName = item.name.replace(/_/g, ' ').replace(/\.json$/i, '');
                        
                        // ** NEW ** Check if test is completed
                        if (studentSubmissions[displayName]) {
                            testButton.innerHTML = `${displayName} <span class="ml-2">‚úÖ</span>`;
                            testButton.className = "test-btn flex items-center justify-center text-center text-white p-8 rounded-2xl shadow-md font-bold text-xl transition-all bg-green-600 opacity-70 cursor-not-allowed";
                            testButton.disabled = true;
                        } else {
                            testButton.textContent = displayName;
                            testButton.className = "test-btn flex items-center justify-center text-center text-white p-8 rounded-2xl shadow-md font-bold text-xl transition-all duration-300 ease-in-out transform hover:scale-105 hover:shadow-lg bg-slate-600 hover:bg-slate-700";
                            testButton.addEventListener('click', () => startTest(item.download_url));
                        }
                        
                        testGrid.appendChild(testButton);
                    });
                }

            } catch (error) {
                console.error("Error fetching GitHub tests:", error);
                errorMessage.textContent = `Error loading tests. (${error.message})`;
            } finally {
                loadingSpinner.classList.add('hidden'); 
            }
        }
        
        // --- 7. TEST TAKER LOGIC ---
        
        async function startTest(downloadUrl) {
            quizForm.innerHTML = '<div class="loader loader-gray mx-auto"></div>';
            quizTitle.textContent = "Loading Test...";
            quizStandard.textContent = "";
            testSubmitMessage.textContent = "";
            
            submitTestBtn.classList.add('hidden');
            nextQuestionBtn.classList.remove('hidden');
            
            animateScreenTransition(testSelectionScreen, testTakerScreen);

            try {
                const response = await fetch(downloadUrl);
                if (!response.ok) throw new Error("Could not download test file.");
                
                const quizData = await response.json();
                currentQuizData = quizData; 
                renderTest(quizData);
                
            } catch (error) {
                console.error("Error starting test:", error);
                // ** START FIX **
                // Handle JSON parse error gracefully
                if (error instanceof SyntaxError) {
                    quizForm.innerHTML = `<p class="text-red-500 text-center">Error: This test file is not valid JSON. Please check the file in your GitHub repository.</p>`;
                } else {
                    quizForm.innerHTML = `<p class="text-red-500 text-center">Error: Could not load this test. Please go back and try again.</p>`;
                }
                // ** END FIX **
                quizNavigation.classList.add('hidden');
            }
        }

        /**
         * ** MODIFIED **
         * Renders all question types including Hot-Text and Constructed-Response
         * ** FIX APPLIED: ** Removed @apply styles and added Tailwind classes directly
         * ** FIX APPLIED: ** Added logic for new "sentences" Hot-Text JSON structure
         */
        function renderTest(quizData) {
            quizForm.innerHTML = ''; 
            quizNavigation.classList.remove('hidden');
            quizTitle.textContent = quizData.title;
            quizStandard.textContent = `Standard: ${quizData.standard}`;
            currentQuestionIndex = 0; 

            quizData.questions.forEach((question, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.id = `question-${index}`;
                questionDiv.className = "question-slide bg-gray-50 p-6 rounded-2xl shadow-inner hidden";
                
                let questionHTML = '';
                
                // ** FIX: Added Tailwind classes for stimulus-box **
                const stimulusHTML = question.stimulus 
                    ? `<div class="bg-white border border-gray-300 rounded-lg p-4 max-h-[300px] overflow-y-auto text-lg text-slate-800 mt-4">${question.stimulus}</div>` 
                    : '';

                if (question.type === "Multiple-Choice") {
                    const optionsArray = question.options.map((option, i) => `
                        <label class="flex items-center p-4 border rounded-xl has-[:checked]:bg-blue-100 has-[:checked]:border-blue-500 cursor-pointer">
                            <input type="radio" name="question-${index}" value="${i}" class="h-5 w-5 text-blue-600" required>
                            <span class="ml-4 text-lg text-slate-700">${option}</span>
                        </label>
                    `).join('');
                    
                    questionHTML = `
                        ${stimulusHTML}
                        <p class="text-xl text-slate-900 mt-4">${question.stem}</p>
                        <div class="space-y-3 mt-4">${optionsArray}</div>
                    `;
                } 
                else if (question.type === "EBSR") {
                    const part1Options = question.part1.options.map((option, i) => `
                        <label class="flex items-center p-4 border rounded-xl has-[:checked]:bg-blue-100 has-[:checked]:border-blue-500 cursor-pointer">
                            <input type="radio" name="question-${index}-part1" value="${i}" class="h-5 w-5 text-blue-600" required>
                            <span class="ml-4 text-lg text-slate-700">${option}</span>
                        </label>
                    `).join('');
                    
                    const part2Options = question.part2.options.map((option, i) => `
                        <label class="flex items-center p-4 border rounded-xl has-[:checked]:bg-blue-100 has-[:checked]:border-blue-500 cursor-pointer">
                            <input type="radio" name="question-${index}-part2" value="${i}" class="h-5 w-5 text-blue-600" required>
                            <span class="ml-4 text-lg text-slate-700">${option}</span>
                        </label>
                    `).join('');

                    questionHTML = `
                        ${stimulusHTML}
                        <p class="text-xl text-slate-900 mt-4 font-semibold">Part A:</p>
                        <p class="text-lg text-slate-800 mt-2">${question.part1.stem}</p>
                        <div class="space-y-3 mt-4">${part1Options}</div>
                        
                        <p class="text-xl text-slate-900 mt-8 font-semibold">Part B:</p>
                        <p class="text-lg text-slate-800 mt-2">${question.part2.stem}</p>
                        <div class="space-y-3 mt-4">${part2Options}</div>
                    `;
                }
                else if (question.type === "Multi-Select") {
                    const optionsArray = question.options.map((option, i) => `
                        <label class="flex items-center p-4 border rounded-xl has-[:checked]:bg-blue-100 has-[:checked]:border-blue-500 cursor-pointer">
                            <input type="checkbox" name="question-${index}" value="${i}" class="h-5 w-5 text-blue-600 rounded">
                            <span class="ml-4 text-lg text-slate-700">${option}</span>
                        </label>
                    `).join('');
                    
                    questionHTML = `
                        ${stimulusHTML}
                        <p class="text-xl text-slate-900 mt-4">${question.stem}</p>
                        <div class="space-y-3 mt-4">${optionsArray}</div>
                    `;
                }
                // ** START MODIFIED DRAG-AND-DROP RENDER **
                else if (question.type === "Drag-and-Drop") {
                    const categoriesHTML = question.categories.map((category, i) => `
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-center text-slate-700">${category}</h3>
                            <!-- ** FIX: Added Tailwind classes for drop-zone ** -->
                            <div class="drop-zone bg-gray-100 border-2 border-dashed border-gray-400 rounded-xl p-4 min-h-[100px] transition-colors" data-category-index="${i}"></div>
                        </div>
                    `).join('');

                    const draggablesHTML = question.draggables.map((item, i) => `
                        <!-- ** FIX: Added Tailwind classes for draggable ** -->
                        <div class="draggable bg-white border border-gray-300 rounded-lg px-4 py-2 cursor-grab text-slate-800 shadow-sm transition-opacity" draggable="true" id="q${index}-drag${i}" data-correct-category="${item.correctCategory}">
                            ${item.text}
                        </div>
                    `).join('');

                    questionHTML = `
                        ${stimulusHTML}
                        <p class="text-xl text-slate-900 mt-4">${question.stem}</p>
                        <div class="flex gap-4 mt-4">${categoriesHTML}</div>
                        <p class="text-center text-slate-500 mt-4">Drag items from this box:</p>
                        <!-- ** FIX: Added Tailwind classes for draggable-pool ** -->
                        <div class="draggable-pool bg-gray-100 border-2 border-dashed border-gray-400 rounded-xl p-4 min-h-[100px] mt-2 flex flex-wrap gap-2">${draggablesHTML}</div>
                    `;
                }
                // ** END MODIFIED DRAG-AND-DROP RENDER **

                // ** START MODIFIED HOT-TEXT RENDER **
                else if (question.type === "Hot-Text") {
                    
                    // --- Check for Hot-Text Type 1: Clickable Paragraph (needs 'text' field) ---
                    if (question.text) {
                        
                        // ** FIX: Use a safer split that preserves sentence markers and spaces **
                        const parts = question.text.split(/(\(\d+\)|\[\d+\])/g).filter(s => s.length > 0);
                        let sentenceIndex = 0;
                        
                        const clickableSentences = parts.map((part) => {
                            const trimmedPart = part.trim();
                            // If it's a sentence marker (like (1) or [1])
                            if (trimmedPart.match(/^(\(\d+\)|\[\d+\])$/)) {
                                return `<span class="font-bold text-blue-600">${trimmedPart}</span>`;
                            } 
                            // If it's a piece of text (a sentence or part of one)
                            else if (trimmedPart.length > 0) {
                                const currentIndex = sentenceIndex;
                                sentenceIndex++;
                                // ** FIX: Added Tailwind classes for hot-text-sentence **
                                return `<span class="hot-text-sentence cursor-pointer transition-all rounded inline-block p-1 hover:bg-blue-100" data-qindex="${index}" data-sentence-index="${currentIndex}">${part}</span>`;
                            }
                            return ''; // Ignore pure whitespace between elements
                        }).join('');

                        // If sentenceIndex is 0, it means the JSON structure was likely wrong.
                        if (sentenceIndex === 0) {
                            console.error(`Hot-Text (Paragraph) JSON Error for Q${index}: 'text' field is present but has no content to split. Structure may be wrong.`);
                            questionHTML = `<p class="text-red-500">Error: This Hot-Text question (Paragraph Type) is incorrectly formatted in the JSON. (Missing sentences)</p>`;
                        } else {
                            questionHTML = `
                                ${stimulusHTML}
                                <p class="text-xl text-slate-900 mt-4">${question.stem}</p>
                                <!-- ** FIX: Added Tailwind classes for hot-text-container ** -->
                                <div class="hot-text-container bg-white border border-gray-300 rounded-lg p-4 text-lg text-slate-800 mt-4">${clickableSentences}</div>
                                <input type="hidden" name="question-${index}" value="">
                            `;
                        }
                    } 
                    // --- Check for Hot-Text Type 2: Clickable Options (needs 'options' field) ---
                    else if (question.options && Array.isArray(question.options)) {
                        
                        const optionsArray = question.options.map((option, i) => `
                            <!-- ** FIX: Added Tailwind classes for hot-text-sentence (options-style) ** -->
                            <div 
                                class="hot-text-option cursor-pointer transition-all rounded inline-block p-1 hover:bg-blue-100 text-lg text-slate-700 border rounded-xl shadow-sm hover:shadow-md transition-shadow duration-100 block w-full p-3 mb-2" 
                                data-qindex="${index}" 
                                data-option-index="${i}">
                                ${option}
                            </div>
                        `).join('');

                        questionHTML = `
                            ${stimulusHTML}
                            <p class="text-xl text-slate-900 mt-4">${question.stem}</p>
                            <div class="mt-4 space-y-2">${optionsArray}</div>
                            <input type="hidden" name="question-${index}" value="">
                        `;
                    }
                    // --- ** NEW ** Check for Hot-Text Type 3: Clickable Sentences (needs 'sentences' field) ---
                    else if (question.sentences && Array.isArray(question.sentences)) {
                        const correctIndexes = [];
                        const clickableSentences = question.sentences.map((sentence, i) => {
                            if (sentence.isCorrect) {
                                correctIndexes.push(i);
                            }
                            // Using the same classes as the 'text' splitter for consistency
                            return `<span class="hot-text-sentence cursor-pointer transition-all rounded inline-block p-1 hover:bg-blue-100" data-qindex="${index}" data-sentence-index="${i}">${sentence.text}</span>`;
                        }).join(' '); // Join with a space

                        questionHTML = `
                            ${stimulusHTML}
                            <p class="text-xl text-slate-900 mt-4">${question.stem}</p>
                            <!-- ** FIX: Added Tailwind classes for hot-text-container ** -->
                            <div class="hot-text-container bg-white border border-gray-300 rounded-lg p-4 text-lg text-slate-800 mt-4">${clickableSentences}</div>
                            <!-- Store the correct answers in a hidden input for grading -->
                            <input type="hidden" name="question-${index}-correct" value="${JSON.stringify(correctIndexes)}">
                            <input type="hidden" name="question-${index}" value="">
                        `;
                    }
                    else {
                        // This fallback is only for truly malformed JSON
                        console.error("Hot-Text question is invalid (missing 'text', 'options', or 'sentences' field):", question);
                        questionHTML = `<p class="text-red-500">Error: This Hot-Text question is invalid. (Missing 'text', 'options', or 'sentences' field in JSON)</p>`;
                    }
                }
                // ** END MODIFIED HOT-TEXT RENDER **

                // ** START NEW CONSTRUCTED-RESPONSE RENDER **
                else if (question.type === "Constructed-Response") {
                    questionHTML = `
                        ${stimulusHTML}
                        <p class="text-xl text-slate-900 mt-4">${question.stem}</p>
                        <textarea name="question-${index}" 
                                  rows="${question.lines || 4}" 
                                  class="w-full mt-4 p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                                  placeholder="Type your answer here..."></textarea>
                    `;
                }
                // ** END NEW CONSTRUCTED-RESPONSE RENDER **
                else {
                    questionHTML = `<p class="text-red-500">Error: This question type (${question.type}) is not supported yet.</p>`;
                }
                
                questionDiv.innerHTML = `
                    <p class="text-lg font-semibold text-slate-700">Question ${index + 1} of ${quizData.questions.length}</p>
                    ${questionHTML}
                `;
                quizForm.appendChild(questionDiv);
            });
            
            // --- EVENT LISTENERS ---
            
            // ** START FIX: MODIFIED HOT-TEXT CLICK LISTENER to use closest() and Tailwind classes **
            quizForm.addEventListener('click', e => {
                // Find the closest clickable parent for either type of hot-text
                const targetElement = e.target.closest('.hot-text-sentence, .hot-text-option'); 
                
                if (targetElement) { // If a clickable element was found
                    const qIndex = targetElement.dataset.qindex;
                    const container = targetElement.closest('.hot-text-container, .space-y-2');
                    const hiddenInput = document.querySelector(`input[name="question-${qIndex}"]`);

                    // Check if this is an "options" based hot-text (only one selection)
                    if (targetElement.classList.contains('hot-text-option')) {
                        // This is a "select one" hot-text
                        container.querySelectorAll('.hot-text-option').forEach(el => {
                            el.classList.remove('bg-blue-200', 'border-blue-500', 'font-medium'); // Remove selected styles
                        });
                        targetElement.classList.add('bg-blue-200', 'border-blue-500', 'font-medium'); // Add selected styles

                        // Store the single selected index
                        hiddenInput.value = targetElement.dataset.optionIndex;

                    } else if (targetElement.classList.contains('hot-text-sentence')) {
                        // This is a "select multiple" (from paragraph or sentences array) hot-text
                        targetElement.classList.toggle('bg-blue-200');
                        targetElement.classList.toggle('border-blue-500');
                        targetElement.classList.toggle('font-medium');
                        
                        const selected = container.querySelectorAll('.bg-blue-200'); // Use class to find selected
                        const selectedIndexes = Array.from(selected).map(el => parseInt(el.dataset.sentenceIndex, 10));
                        hiddenInput.value = JSON.stringify(selectedIndexes);
                    }
                }
            });
            // ** END FIX: MODIFIED HOT-TEXT CLICK LISTENER **
            
            // ** START FIX: MODIFIED DRAG-AND-DROP LISTENERS to use Tailwind classes **
            quizForm.addEventListener('dragstart', e => {
                if (e.target.classList.contains('draggable')) {
                    draggedItem = e.target;
                    e.dataTransfer.setData('text/plain', e.target.id);
                    setTimeout(() => e.target.classList.add('opacity-50', 'shadow-lg', 'cursor-grabbing'), 0);
                }
            });

            quizForm.addEventListener('dragend', e => {
                if (draggedItem) {
                    draggedItem.classList.remove('opacity-50', 'shadow-lg', 'cursor-grabbing');
                    draggedItem = null;
                }
            });

            quizForm.addEventListener('dragover', e => {
                const dropZone = e.target.closest('.drop-zone, .draggable-pool');
                if (dropZone) {
                    e.preventDefault();
                    dropZone.classList.add('bg-blue-100', 'border-blue-500');
                }
            });
            
            quizForm.addEventListener('dragleave', e => {
                 const dropZone = e.target.closest('.drop-zone, .draggable-pool');
                 if (dropZone) {
                    dropZone.classList.remove('bg-blue-100', 'border-blue-500');
                 }
            });
            // ** END FIX: MODIFIED DRAG-AND-DROP LISTENERS **

            quizForm.addEventListener('drop', e => {
                const dropZone = e.target.closest('.drop-zone, .draggable-pool');
                if (dropZone) {
                    e.preventDefault();
                    dropZone.classList.remove('bg-blue-100', 'border-blue-500');
                    if(draggedItem) {
                        dropZone.appendChild(draggedItem);
                        draggedItem.dataset.selectedCategory = dropZone.dataset.categoryIndex ?? 'pool';
                    }
                }
            });
            
            showQuestion(0);
        }
        
        function showQuestion(index) {
            document.querySelectorAll('.question-slide').forEach(slide => {
                slide.classList.add('hidden');
            });
            
            const targetQuestion = document.getElementById(`question-${index}`);
            if (targetQuestion) {
                targetQuestion.classList.remove('hidden');
            }

            currentQuestionIndex = index;
            questionCounter.textContent = `Question ${index + 1} of ${currentQuizData.questions.length}`;
            prevQuestionBtn.disabled = (index === 0);

            if (index === currentQuizData.questions.length - 1) {
                nextQuestionBtn.classList.add('hidden');
                submitTestBtn.classList.remove('hidden');
            } else {
                nextQuestionBtn.classList.remove('hidden');
                submitTestBtn.classList.add('hidden');
            }
        }
        
        nextQuestionBtn.addEventListener('click', () => {
            showQuestion(currentQuestionIndex + 1);
        });
        
        prevQuestionBtn.addEventListener('click', () => {
            showQuestion(currentQuestionIndex - 1);
        });
        
        quizForm.addEventListener('submit', (e) => {
            e.preventDefault();
            handleSubmitTest();
        });
        
        submitTestBtn.addEventListener('click', () => {
            let allValid = true;
            let firstInvalid = -1;
            testSubmitMessage.textContent = "";

            for(let i = 0; i < currentQuizData.questions.length; i++) {
                const q = currentQuizData.questions[i];
                if (q.type === "Multiple-Choice" || q.type === "EBSR") {
                     const inputs = quizForm.querySelectorAll(`input[name="question-${i}"]`);
                     if (inputs.length > 0 && !quizForm.querySelector(`input[name="question-${i}"]:checked`)) {
                        allValid = false;
                        firstInvalid = i;
                        break;
                     }
                    if (q.type === "EBSR") {
                        const inputs2 = quizForm.querySelectorAll(`input[name="question-${i}-part2"]`);
                         if (inputs2.length > 0 && !quizForm.querySelector(`input[name="question-${i}-part2"]:checked`)) {
                            allValid = false;
                            firstInvalid = i;
                            break;
                         }
                    }
                }
                else if (q.type === "Multi-Select") {
                    const inputs = quizForm.querySelectorAll(`input[name="question-${i}"]:checked`);
                    if (inputs.length === 0) {
                        allValid = false;
                        firstInvalid = i;
                        testSubmitMessage.textContent = `Please select at least one option for Question ${i + 1}.`;
                        break;
                    }
                }
                else if (q.type === "Drag-and-Drop") {
                    const itemsInPool = quizForm.querySelectorAll(`#question-${i} .draggable-pool .draggable`);
                    if (itemsInPool.length > 0) {
                        allValid = false;
                        firstInvalid = i;
                        testSubmitMessage.textContent = `Please drag all items to a category for Question ${i + 1}.`;
                        break;
                    }
                }
                // ** START MODIFIED HOT-TEXT VALIDATION **
                else if (q.type === "Hot-Text") {
                    const hiddenInput = quizForm.querySelector(`input[name="question-${i}"]`);
                    let isValid = false;
                    
                    // ** MODIFIED ** Check all 3 types
                    if (q.correctAnswerIndexes || (q.sentences && Array.isArray(q.sentences))) { // "select multiple" type (paragraph splitting or sentences array)
                        if (hiddenInput && hiddenInput.value && hiddenInput.value !== "[]") {
                            isValid = true;
                        }
                    } else if (q.correctAnswerIndex !== undefined) { // "select one" type (options array)
                        if (hiddenInput && hiddenInput.value !== "") {
                            isValid = true;
                        }
                    }
                    
                    // Fallback check if hidden input somehow failed to render
                    if (!hiddenInput && (q.correctAnswerIndexes || q.correctAnswerIndex !== undefined || q.sentences)) {
                         console.error("Validation failed: Could not find hidden input for Hot-Text Q" + i);
                    }


                    if (!isValid) {
                        allValid = false;
                        firstInvalid = i;
                        testSubmitMessage.textContent = `Please select an answer for Question ${i + 1}.`;
                        break;
                    }
                }
                // ** END MODIFIED HOT-TEXT VALIDATION **
                
                // ** NEW ** Validation for Constructed-Response
                else if (q.type === "Constructed-Response") {
                    const textarea = quizForm.querySelector(`textarea[name="question-${i}"]`);
                    if (!textarea.value.trim()) {
                        allValid = false;
                        firstInvalid = i;
                        testSubmitMessage.textContent = `Please write an answer for Question ${i + 1}.`;
                        break;
                    }
                }
            }
            
            if (allValid) {
                quizForm.requestSubmit();
            } else {
                if(firstInvalid !== -1) {
                    showQuestion(firstInvalid);
                    if (!testSubmitMessage.textContent) {
                         testSubmitMessage.textContent = `Please answer Question ${firstInvalid + 1}.`;
                    }
                }
            }
        });

        function arraysEqual(a, b) {
            // ** FIX: Added Array.isArray checks to prevent 'Cannot read properties of undefined (reading 'length')' **
            if (!Array.isArray(a) || !Array.isArray(b) || a.length !== b.length) return false;
            
            const sortedA = [...a].sort();
            const sortedB = [...b].sort();
            for (let i = 0; i < sortedA.length; i++) {
                if (sortedA[i] !== sortedB[i]) return false;
            }
            return true;
        }

        /**
         * ** MODIFIED **
         * Now grades all types of Hot-Text and saves Constructed-Response
         */
        async function handleSubmitTest() {
            if (!currentQuizData || !currentUserId) return;
            
            testSubmitMessage.textContent = "Submitting...";

            let score = 0;
            let totalAutoGraded = 0; // Total questions that can be auto-graded
            const failedSkills = new Set();
            const formData = new FormData(quizForm);
            const constructedResponses = []; // ** NEW ** To store written answers

            currentQuizData.questions.forEach((question, index) => {
                let isCorrect = false;
                
                if (question.type === "Multiple-Choice") {
                    totalAutoGraded++;
                    const selectedAnswer = formData.get(`question-${index}`); 
                    if (selectedAnswer == question.correctAnswerIndex) {
                        isCorrect = true;
                    }
                } 
                else if (question.type === "EBSR") {
                    totalAutoGraded++;
                    const part1Answer = formData.get(`question-${index}-part1`);
                    const part2Answer = formData.get(`question-${index}-part2`);
                    if (part1Answer == question.part1.correctAnswerIndex && part2Answer == question.part2.correctAnswerIndex) {
                        isCorrect = true;
                    }
                }
                else if (question.type === "Multi-Select") {
                    totalAutoGraded++;
                    const selectedAnswers = formData.getAll(`question-${index}`).map(val => parseInt(val, 10));
                    const correctAnswers = question.correctAnswerIndexes;
                    
                    if (arraysEqual(selectedAnswers, correctAnswers)) {
                        isCorrect = true;
                    }
                }
                else if (question.type === "Drag-and-Drop") {
                    totalAutoGraded++;
                    const draggables = quizForm.querySelectorAll(`#question-${index} .draggable`);
                    let allCorrect = true;
                    
                    draggables.forEach(item => {
                        const selectedCat = item.dataset.selectedCategory;
                        const correctCat = item.dataset.correctCategory;
                        if (selectedCat !== correctCat) {
                            allCorrect = false;
                        }
                    });
                    
                    isCorrect = allCorrect;
                }
                // ** START MODIFIED HOT-TEXT GRADING **
                else if (question.type === "Hot-Text") {
                    totalAutoGraded++;
                    const hiddenInput = quizForm.querySelector(`input[name="question-${index}"]`);
                    
                    // Check which type of Hot-Text it is
                    if (question.correctAnswerIndexes) {
                        // This is the "select multiple from paragraph" type
                        let selectedIndexes = [];
                        try {
                            // Ensure hiddenInput.value is valid JSON
                            if (hiddenInput && hiddenInput.value) {
                                selectedIndexes = JSON.parse(hiddenInput.value).map(val => parseInt(val, 10));
                            }
                        } catch (e) {
                            console.error("Invalid JSON in hot-text hidden input:", hiddenInput.value);
                            selectedIndexes = []; // Default to empty if parsing fails
                        }
                        const correctIndexes = question.correctAnswerIndexes;
                        if (arraysEqual(selectedIndexes, correctIndexes)) {
                            isCorrect = true;
                        }
                    } else if (question.correctAnswerIndex !== undefined) {
                        // This is the "select one from options" type
                        if (hiddenInput && hiddenInput.value == question.correctAnswerIndex) {
                            isCorrect = true;
                        }
                    }
                    // --- ** NEW ** Grading for 'sentences' structure ---
                    else if (question.sentences && Array.isArray(question.sentences)) {
                        // Get the correct answers we stored in the hidden input
                        const correctInput = quizForm.querySelector(`input[name="question-${index}-correct"]`);
                        const correctIndexes = JSON.parse(correctInput.value);

                        // Get the student's selected answers
                        let selectedIndexes = [];
                        try {
                            if (hiddenInput && hiddenInput.value) {
                                selectedIndexes = JSON.parse(hiddenInput.value).map(val => parseInt(val, 10));
                            }
                        } catch (e) {
                            console.error("Invalid JSON in hot-text hidden input:", hiddenInput.value);
                            selectedIndexes = [];
                        }

                        if (arraysEqual(selectedIndexes, correctIndexes)) {
                            isCorrect = true;
                        }
                    }
                }
                // ** END MODIFIED HOT-TEXT GRADING **

                // ** START NEW CONSTRUCTED-RESPONSE SAVING **
                else if (question.type === "Constructed-Response") {
                    const textarea = quizForm.querySelector(`textarea[name="question-${index}"]`);
                    constructedResponses.push({
                        questionStem: question.stem,
                        answer: textarea.value
                    });
                    // This question is not auto-graded, so isCorrect remains false
                    // and it doesn't count towards totalAutoGraded
                }
                // ** END NEW CONSTRUCTED-RESPONSE SAVING **

                
                if(isCorrect) {
                    score++;
                } else if (question.type !== "Constructed-Response") { // Don't count CR as "failed"
                    if(question.skill) {
                        failedSkills.add(question.skill);
                    }
                }
            });

            const total = currentQuizData.questions.length;
            const percentage = (totalAutoGraded > 0) ? Math.round((score / totalAutoGraded) * 100) : 0;
            const passingScore = currentQuizData.passingScore || (totalAutoGraded * 0.7);
            
            currentFailedSkills = Array.from(failedSkills); // ** NEW ** Save failed skills

            // ** MODIFIED ** Show auto-graded score
            finalScore.textContent = `${score} / ${totalAutoGraded}`;
            let scoreMessageText = '';
            if (totalAutoGraded < total) {
                scoreMessageText = `(Your written answer will be reviewed by your teacher.)<br>`;
            }

            if (score >= passingScore) {
                scoreMessageText += `Congratulations, you passed! (${percentage}%)`;
                aiReportSection.classList.add('hidden'); 
            } else {
                scoreMessageText += `Don't give up, you'll get it next time! (${percentage}%)`;
                aiReportSection.classList.remove('hidden'); 
                aiReportContent.innerHTML = ''; // Clear old report
                aiReportMessage.textContent = ''; // Clear old message
            }
            scoreMessage.innerHTML = scoreMessageText;
            
            animateScreenTransition(testTakerScreen, scoreScreen);
            
            testSubmitMessage.textContent = "";

            try {
                // ** NEW ** Check if submission already exists (idempotency)
                const submissionsRef = collection(db, "submissions");
                const q = query(submissionsRef, 
                    where("studentId", "==", currentUserId),
                    where("testTitle", "==", currentQuizData.title)
                );
                const existingSub = await getDocs(q);

                if (existingSub.empty) {
                    await addDoc(submissionsRef, {
                        studentId: currentUserId,
                        studentEmail: auth.currentUser.email, 
                        testTitle: currentQuizData.title,
                        testStandard: currentQuizData.standard,
                        score: score,
                        totalQuestions: total,
                        totalAutoGraded: totalAutoGraded, // ** NEW **
                        percentage: percentage,
                        failedSkills: currentFailedSkills,
                        constructedResponses: constructedResponses, // ** NEW **
                        submittedAt: serverTimestamp()
                    });
                }
            } catch (error) {
                console.error("Error saving submission:", error);
            }
        }
        
        // ** NEW ** AI Report Function
        const getAiRemediation = httpsCallable(functions, 'getAiRemediation');

        getAiReportBtn.addEventListener('click', async () => {
            if (currentFailedSkills.length === 0) {
                aiReportMessage.textContent = "No failed skills recorded.";
                return;
            }
            
            aiReportMessage.textContent = "ü§ñ Generating your personal practice plan...";
            getAiReportBtn.disabled = true;

            try {
                // ** MODIFIED ** Call the Firebase Function
                const result = await getAiRemediation({ skills: currentFailedSkills });
                
                // The backend function returns HTML, so we set it directly
                aiReportContent.innerHTML = result.data.html;
                aiReportMessage.textContent = ""; // Clear loading message

            } catch (error) {
                console.error("Error calling getAiRemediation function:", error);
                aiReportMessage.textContent = "Error: Could not generate report. Please try again later.";
                aiReportContent.innerHTML = `<p class="text-red-500">There was an error connecting to the AI. Please check the console for details.</p>`;
            } finally {
                getAiReportBtn.disabled = false;
            }
        });


        // --- 8. TEACHER DASHBOARD LOGIC ---
        
        // ** NEW ** Create Student Function
        const createStudent = httpsCallable(functions, 'createStudent');

        createStudentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            createStudentMessage.textContent = "Creating student...";
            createStudentBtn.disabled = true;

            const email = studentEmail.value;
            const password = studentPassword.value;

            try {
                const result = await createStudent({ email: email, password: password });
                
                createStudentMessage.textContent = result.data.message;
                createStudentMessage.classList.remove('text-red-500');
                createStudentMessage.classList.add('text-green-600');
                
                createStudentForm.reset();

            } catch (error) {
                console.error("Error calling createStudent function:", error);
                createStudentMessage.textContent = `Error: ${error.message}`;
                createStudentMessage.classList.add('text-red-500');
                createStudentMessage.classList.remove('text-green-600');
            } finally {
                createStudentBtn.disabled = false;
            }
        });

        refreshScoresBtn.addEventListener('click', fetchStudentScores);

        async function fetchStudentScores() {
            scoresMessage.textContent = "Loading scores...";
            scoresListContainer.innerHTML = ''; 
            resetMessage.textContent = "";
            let testGroups = new Map(); // Map to hold scores grouped by test title

            try {
                const q = query(collection(db, "submissions"));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    scoresMessage.textContent = "No student submissions found.";
                    return;
                }

                // 1. Group submissions by test title
                querySnapshot.forEach((doc) => {
                    const submission = doc.data();
                    const submissionId = doc.id; 
                    const title = submission.testTitle;

                    if (!testGroups.has(title)) {
                        testGroups.set(title, []);
                    }
                    testGroups.get(title).push({...submission, id: submissionId});
                });
                
                // 2. Render grouped results
                let renderedHTML = '';
                testGroups.forEach((submissions, title) => {
                    let submissionsHTML = submissions.map(submission => {
                        let writtenResponseHTML = '';
                        if (submission.constructedResponses && submission.constructedResponses.length > 0) {
                            const responses = submission.constructedResponses.map(r => 
                                `<div class="mt-2 text-xs text-gray-600 p-2 border-t border-gray-200">
                                    <strong class="text-gray-700 block">${r.questionStem}</strong>
                                    <em class="block ml-1 mt-1">${submission.studentEmail || 'Unknown Student'} wrote: ${r.answer}</em>
                                Nothing to add.</div>`
                            ).join('');
                            writtenResponseHTML = `<details class="mt-2"><summary class="text-xs text-blue-600 cursor-pointer hover:underline">View Written Answers</summary><div class="bg-white p-2 rounded-md">${responses}</div></details>`;
                        }
                        
                        return `
                            <div class="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm border border-gray-200 mb-2">
                                <div>
                                    <p class="font-semibold text-slate-700">${submission.studentEmail || 'Unknown Student'}</p>
                                    <p class="text-xs text-slate-500">Submitted: ${submission.submittedAt ? new Date(submission.submittedAt.seconds * 1000).toLocaleString() : 'N/A'}</p>
                                    ${writtenResponseHTML}
                                </div>
                                <div class="text-right flex-shrink-0 ml-4">
                                    <p class="font-bold text-blue-600">${submission.score} / ${submission.totalAutoGraded}</p>
                                    <p class="text-xs text-gray-500">${submission.percentage}%</p>
                                    <button data-id="${submission.id}" class="reset-btn text-xs text-red-500 hover:underline">
                                        Reset
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');

                    // Wrap each test group in a <details> tag
                    renderedHTML += `
                        <details class="bg-white p-4 rounded-xl shadow-md border border-gray-200">
                            <summary class="font-bold text-lg text-slate-800 cursor-pointer">
                                ${title} (${submissions.length} Submissions)
                            </summary>
                            <div class="mt-3 space-y-3">
                                ${submissionsHTML}
                            </div>
                        </details>
                    `;
                });

                scoresListContainer.innerHTML = renderedHTML;
                scoresMessage.textContent = "";

                // 3. Attach click handlers to the new Reset buttons
                document.querySelectorAll('.reset-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const subId = e.currentTarget.dataset.id;
                        if (confirm("Are you sure you want to reset this student's score? This cannot be undone.")) {
                            resetScore(subId);
                        }
                    });
                });

            } catch (error)
            {
                console.error("Error fetching scores:", error);
                if (error.code === 'permission-denied') {
                    scoresMessage.innerHTML = `<span class="font-bold text-red-600">Error: Permission Denied.</span><br>You must update your Firestore Rules to allow teachers to read the 'submissions' collection.`;
                    console.log("--- FIX FOR PERMISSION DENIED ---");
                    console.log("Go to your Firebase Project -> Firestore Database -> Rules tab.");
                    console.log("Copy and paste these rules and click 'Publish':");
                    console.log(`
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if false; 
    }

    match /submissions/{submissionId} {
      allow create: if request.auth != null && request.resource.data.studentId == request.auth.uid;
      // ** MODIFIED ** Allow teachers to list (query)
      allow list, read, delete: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'teacher';
      
      // ** NEW ** Allow students to read/list their OWN submissions for test locking
      allow read: if request.auth != null && request.auth.uid == resource.data.studentId;
      allow list: if request.auth != null && request.query.where.length > 0 && request.query.where[0][0] == 'studentId' && request.query.where[0][2] == request.auth.uid;
    }
  }
}
                    `);
                    console.log("--- END OF FIX ---");
                } else {
                    scoresMessage.textContent = "An error occurred fetching scores.";
                }
            }
        }

        async function resetScore(submissionId) {
            resetMessage.textContent = "Resetting score...";
            
            try {
                const submissionRef = doc(db, "submissions", submissionId);
                
                await deleteDoc(submissionRef);
                
                resetMessage.textContent = "Score reset successfully.";
                
                // Refresh the scores list
                await fetchStudentScores();

            } catch (error) {
                console.error("Error resetting score:", error);
                if (error.code === 'permission-denied') {
                    resetMessage.textContent = "Error: You do not have permission to reset scores.";
                    console.log("FIX: Ensure your 'submissions' rule allows 'delete' for teachers. (See rule from 'Error fetching scores'.)");
                } else {
                    resetMessage.textContent = "An error occurred while resetting.";
                }
            }
        }

    </script>

</body>
</html>

